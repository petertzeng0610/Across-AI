# 📋 資安事件通報單生成功能說明

## 功能概述

本功能實現了「方案 A（兩階段 AI）」的報告生成流程：

1. **第一階段 AI**：現有的 WAF 風險分析（已完成）
2. **第二階段 AI**：將分析結果轉換為政府標準「資通安全事件通報單」格式

---

## 架構說明

### 後端新增檔案

```
backend/
├── services/reports/
│   ├── reportGeneratorService.js    # 報告生成核心服務
│   └── wordReportService.js         # Word 填充服務
├── routes/
│   └── report.routes.js             # 報告 API 路由
├── prompts/
│   └── security-report-generation-prompt.md  # 報告轉譯 Prompt
└── templates/
    └── 網頁攻擊資安報告-template.docx  # Word 模板
```

### 前端新增檔案

```
frontend/
├── hooks/
│   └── use-report-download.ts       # 報告下載 Hook
└── components/
    └── report-download-dialog.tsx   # 報告下載對話框
```

---

## API 端點

### 1. 完整報告生成（第二階段 AI）

```
POST /api/reports/generate
```

**Request Body:**
```json
{
  "analysisData": { "risks": [...] },
  "metadata": {
    "totalEvents": 1000,
    "timeRange": { "start": "...", "end": "..." },
    "platform": "cloudflare"
  },
  "userProvidedData": {
    "organizationName": "公司名稱",
    "reporterName": "通報人姓名",
    ...
  },
  "aiConfig": {
    "provider": "ollama",
    "model": "twister_llama33:latest"
  },
  "outputFormat": "text" | "word" | "json"
}
```

### 2. 快速純文字報告（不使用 AI 轉譯）

```
POST /api/reports/generate-text
```

### 3. 直接下載純文字報告

```
POST /api/reports/download-text
```

### 4. 取得模板列表

```
GET /api/reports/templates
```

### 5. 服務健康檢查

```
GET /api/reports/health
```

---

## 使用流程

### 方式一：快速下載（推薦初次使用）

1. 完成 AI 分析後，點擊「生成報告」按鈕
2. 在對話框中選擇「快速下載」標籤頁
3. 點擊「快速下載純文字報告」

### 方式二：完整報告（正式用途）

1. 完成 AI 分析後，點擊「生成報告」按鈕
2. 在對話框中選擇「完整報告」標籤頁
3. 填寫機關基本資料（機關名稱、通報人等）
4. 點擊「下載 TXT 報告」或「下載 Word 報告」

---

## 報告格式說明

生成的報告符合台灣政府「資通安全事件通報單」標準格式，包含以下章節：

### 通報階段-事件通報

- **Step 1**: 事件相關基本資料（機關、通報人、聯絡方式）
- **Step 2**: 事件發生過程（事件分類、說明、影響範圍）
- **Step 3**: 評估事件影響等級（機密性、完整性、可用性）
- **Step 4**: 是否需要外部支援

### 應變處置階段-損害控制或復原

- **Step 5**: 機關緊急應變措施
  - 保留受害期間紀錄
  - 事件分析與影響評估
  - 封鎖、根除及復原措施

### 結報階段-調查、處理及改善報告

- **Step 6**: 資安事件結案作業
  - 受駭設備資訊
  - 系統與 SOC 資訊
  - 事件發生原因
  - 補強措施

### AI 分析洞見

- 攻擊模式分析
- 威脅行為者特徵
- 優先處理事項
- 長期建議

---

## 技術實現

### 第二階段 AI Prompt 設計

報告轉譯 Prompt（`security-report-generation-prompt.md`）包含：

1. **角色定義**：專業資安事件報告分析師
2. **輸入資料結構**：AI 分析結果、元資料、風險統計
3. **輸出 JSON 結構**：完整的通報單欄位定義
4. **欄位判定規則**：
   - 事件分類判定（根據攻擊類型）
   - 影響等級判定（根據風險嚴重程度）
   - 事件原因判定（根據攻擊模式）

### Word 模板變數

模板使用 `{{變數名}}` 語法，支援的變數包括：

```
{{reportTime}}          - 填報時間
{{organizationName}}    - 機關名稱
{{eventDiscoveryTime}}  - 知悉事件時間
{{eventDescription}}    - 事件說明
{{confidentialityLevel}} - 機密性等級
{{blockedIPs}}          - 阻擋的 IP 列表
...
```

---

## 安裝需求

### 後端套件

```bash
cd backend
npm install docx-templates
```

### 環境變數

確保 `.env` 中有設定：

```env
GEMINI_API_KEY=your_api_key  # 如果使用 Gemini
OLLAMA_URL=http://localhost:11434  # 如果使用 Ollama
```

---

## 疑難排解

### Q1: Word 報告生成失敗？

**A**: 系統會自動回退到純文字格式。確認：
- `docx-templates` 套件已安裝
- 模板檔案存在於 `backend/templates/` 目錄

### Q2: AI 回應格式錯誤？

**A**: 系統有 JSON 解析容錯機制，會嘗試：
1. 直接解析 JSON
2. 從 markdown code block 中提取 JSON
3. 使用正則表達式匹配 JSON 物件

### Q3: 報告內容不完整？

**A**: 第二階段 AI 會根據輸入資料填充欄位。如果某些欄位為空：
- 檢查 AI 分析結果是否完整
- 手動填寫用戶資料（機關名稱、通報人等）

---

## 未來擴展

1. **PDF 報告支持**：整合 pdf-lib 或 puppeteer
2. **報告模板管理**：支援多種報告模板選擇
3. **報告歷史紀錄**：保存已生成的報告
4. **報告審核流程**：加入主管審核機制

---

## 更新日誌

- **2024-12-03**: 初版完成
  - 實現方案 A（兩階段 AI）
  - 支援純文字和 Word 格式
  - 整合前端報告下載對話框

