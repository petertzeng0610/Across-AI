// Cloudflare WAF é¢¨éšªåˆ†ææœå‹™
// å°ˆé–€åˆ†æ Cloudflare WAF æ—¥èªŒä¸¦ç”Ÿæˆé¢¨éšªè©•ä¼°å ±å‘Š
// ä½¿ç”¨ç¾æœ‰çš„ elkMCPClientã€ELK_CONFIG å’Œ cloudflare-field-mapping
// åŸºæ–¼ Cloudflare å®˜æ–¹æ¨™æº– (cloudflareStandards.js)

const { elkMCPClient } = require('./elkMCPClient');
const { ELK_CONFIG } = require('../config/elkConfig');
const { CLOUDFLARE_FIELD_MAPPING } = require('../../cloudflare-field-mapping');
const {
  classifyWAFScore,
  isCloudflareInternalEndpoint,
  isValidWAFScore,
  isRealSecurityThreat,
  calculateValidAvgScore,
  RECOMMENDED_THRESHOLDS,
  WAF_SCORE_CLASSIFICATION
} = require('../config/cloudflareStandards');

class CloudflareWAFRiskService {
  constructor() {
    console.log('ğŸ”§ åˆå§‹åŒ– Cloudflare WAF é¢¨éšªåˆ†ææœå‹™...');
    this.elkClient = elkMCPClient;
    this.elkConfig = ELK_CONFIG;
    this.fieldMapping = CLOUDFLARE_FIELD_MAPPING;
  }
  
  // â­ ä¸»è¦æ–¹æ³•ï¼šåˆ†æ Cloudflare WAF é¢¨éšª
  async analyzeCloudflareWAF(timeRange = '24h') {
    console.log(`\nğŸ” ===== é–‹å§‹ Cloudflare WAF é¢¨éšªåˆ†æ =====`);
    console.log(`ğŸ“… æ™‚é–“ç¯„åœ: ${timeRange}`);
    console.log(`ğŸ“Š ç´¢å¼•: ${this.elkConfig.elasticsearch.index}`);
    
    try {
      // â­ Step 1: é€é ELK MCP æŸ¥è©¢ Cloudflare æ—¥èªŒ
      console.log('\nâ­ Step 1: é€é MCP æŸ¥è©¢ Cloudflare æ—¥èªŒ...');
      const elkData = await this.elkClient.queryElasticsearch(timeRange);
      
      if (!elkData.hits || elkData.hits.length === 0) {
        console.log('âš ï¸ æœªæ‰¾åˆ°æ—¥èªŒè³‡æ–™');
        return this.getEmptyAnalysisResult();
      }
      
      // Step 2: ä½¿ç”¨ cloudflare-field-mapping è§£æè³‡æ–™
      console.log(`\nâ­ Step 2: è§£æ ${elkData.hits.length} ç­†æ—¥èªŒ...`);
      const logEntries = elkData.hits.map(hit => this.parseCloudflareLog(hit.source));
      console.log(`âœ… æˆåŠŸè§£æ ${logEntries.length} ç­†æ—¥èªŒ`);
      
      // Step 3: åˆ†æå„ç¨®æ”»æ“Šé¡å‹
      console.log('\nâ­ Step 3: åˆ†ææ”»æ“Šæ¨¡å¼...');
      const sqlInjection = this.analyzeSQLInjection(logEntries);
      console.log(`   SQL æ³¨å…¥: ${sqlInjection.count} æ¬¡ (é«˜é¢¨éšª: ${sqlInjection.highRisk})`);
      
      const xssAttacks = this.analyzeXSSAttacks(logEntries);
      console.log(`   XSS æ”»æ“Š: ${xssAttacks.count} æ¬¡ (é«˜é¢¨éšª: ${xssAttacks.highRisk})`);
      
      const rceAttacks = this.analyzeRCEAttacks(logEntries);
      console.log(`   RCE æ”»æ“Š: ${rceAttacks.count} æ¬¡ (é«˜é¢¨éšª: ${rceAttacks.highRisk})`);
      
      const botTraffic = this.analyzeBotTraffic(logEntries);
      console.log(`   æƒ¡æ„æ©Ÿå™¨äºº: ${botTraffic.count} æ¬¡`);
      
      const pathTraversal = this.analyzePathTraversal(logEntries);
      console.log(`   è·¯å¾‘éæ­·: ${pathTraversal.count} æ¬¡`);
      
      const abnormalUA = this.analyzeAbnormalUA(logEntries);
      console.log(`   ç•°å¸¸ UA: ${abnormalUA.count} æ¬¡`);
      
      // Step 4: ç”Ÿæˆåœ°ç†å’Œæ™‚é–“åˆ†æ
      console.log('\nâ­ Step 4: ç”Ÿæˆçµ±è¨ˆè³‡æ–™...');
      const geoAnalysis = this.analyzeGeoDistribution(logEntries);
      const assetAnalysis = this.analyzeAffectedAssets(logEntries);
      
      // è¨ˆç®—æ™‚é–“ç¯„åœ
      const timestamps = logEntries
        .map(log => log.timestamp)
        .filter(t => t)
        .map(t => new Date(t).getTime());
      
      const timeRange_result = {
        start: timestamps.length > 0 ? new Date(Math.min(...timestamps)).toISOString() : new Date().toISOString(),
        end: timestamps.length > 0 ? new Date(Math.max(...timestamps)).toISOString() : new Date().toISOString()
      };
      
      console.log('\nâœ… ===== Cloudflare WAF é¢¨éšªåˆ†æå®Œæˆ =====\n');
      
      return {
        sqlInjection,
        xssAttacks,
        rceAttacks,
        botTraffic,
        pathTraversal,
        abnormalUA,
        geoAnalysis,
        assetAnalysis,
        totalEvents: logEntries.length,
        timeRange: timeRange_result
      };
      
    } catch (error) {
      console.error('âŒ Cloudflare WAF é¢¨éšªåˆ†æå¤±æ•—:', error);
      throw error;
    }
  }
  
  // è§£æ Cloudflare æ—¥èªŒï¼ˆä½¿ç”¨ cloudflare-field-mappingï¼‰
  parseCloudflareLog(rawLog) {
    return {
      rayId: rawLog[this.fieldMapping.ray_id.elk_field],
      clientIP: rawLog[this.fieldMapping.client_ip.elk_field],
      clientCountry: rawLog[this.fieldMapping.client_country.elk_field],
      clientASN: rawLog[this.fieldMapping.client_asn.elk_field],
      requestURI: rawLog[this.fieldMapping.client_request_uri.elk_field],
      requestMethod: rawLog[this.fieldMapping.client_request_method.elk_field],
      userAgent: rawLog[this.fieldMapping.client_request_user_agent.elk_field],
      wafAttackScore: rawLog[this.fieldMapping.waf_attack_score.elk_field],
      wafSQLiScore: rawLog[this.fieldMapping.waf_sqli_attack_score.elk_field],
      wafXSSScore: rawLog[this.fieldMapping.waf_xss_attack_score.elk_field],
      wafRCEScore: rawLog[this.fieldMapping.waf_rce_attack_score.elk_field],
      securityAction: rawLog[this.fieldMapping.security_action.elk_field],
      securityRule: rawLog[this.fieldMapping.security_rule_id.elk_field],  // ä¿®å¾©ï¼šsecurity_rule_description â†’ security_rule_id
      edgeHost: rawLog[this.fieldMapping.client_request_host.elk_field],    // ä¿®å¾©ï¼šedge_request_host â†’ client_request_host
      timestamp: rawLog[this.fieldMapping.edge_start_timestamp.elk_field]
    };
  }
  
  // åˆ†æ SQL æ³¨å…¥ï¼ˆä½¿ç”¨ Cloudflare å®˜æ–¹æ¨™æº–ï¼‰
  // å®˜æ–¹å®šç¾©ï¼šåˆ†æ•¸ 1-20 = Attack, 21-50 = Likely Attack
  analyzeSQLInjection(logEntries) {
    // éæ¿¾ï¼šæ’é™¤å…§éƒ¨ç«¯é» + æœ‰æ•ˆåˆ†æ•¸ + åˆ†æ•¸ <= 50
    const sqliLogs = logEntries.filter(log => 
      !isCloudflareInternalEndpoint(log.requestURI) &&  // âœ… æ’é™¤ Cloudflare å…§éƒ¨æœå‹™
      (
        (isValidWAFScore(log.wafSQLiScore) && log.wafSQLiScore <= 50) ||  // âœ… æœ‰æ•ˆåˆ†æ•¸ 1-50
        (log.securityRule && log.securityRule.toLowerCase().includes('sql'))  // æˆ–è§¸ç™¼ SQL è¦å‰‡
      )
    );
    
    // é«˜é¢¨éšªï¼šåˆ†æ•¸ 1-20ï¼ˆå®˜æ–¹ Attack ç´šåˆ¥ï¼‰
    const highRiskLogs = sqliLogs.filter(log => 
      isValidWAFScore(log.wafSQLiScore) && 
      log.wafSQLiScore >= 1 && 
      log.wafSQLiScore <= RECOMMENDED_THRESHOLDS.HIGH  // <= 20
    );
    
    return {
      count: sqliLogs.length,
      highRisk: highRiskLogs.length,
      topIPs: this.getTopN(sqliLogs, 'clientIP', 10),
      topTargets: this.getTopN(sqliLogs, 'requestURI', 10),
      topCountries: this.getTopN(sqliLogs, 'clientCountry', 5),
      affectedAssets: new Set(sqliLogs.map(log => log.edgeHost).filter(h => h)).size,
      avgScore: calculateValidAvgScore(sqliLogs, 'wafSQLiScore')  // âœ… åªè¨ˆç®—æœ‰æ•ˆåˆ†æ•¸
    };
  }
  
  // åˆ†æ XSS æ”»æ“Šï¼ˆä½¿ç”¨ Cloudflare å®˜æ–¹æ¨™æº–ï¼‰
  analyzeXSSAttacks(logEntries) {
    const xssLogs = logEntries.filter(log => 
      !isCloudflareInternalEndpoint(log.requestURI) &&  // âœ… æ’é™¤å…§éƒ¨ç«¯é»
      (
        (isValidWAFScore(log.wafXSSScore) && log.wafXSSScore <= 50) ||  // âœ… æœ‰æ•ˆåˆ†æ•¸ 1-50
        (log.securityRule && log.securityRule.toLowerCase().includes('xss')) ||
        (log.requestURI && (log.requestURI.includes('<script') || log.requestURI.includes('javascript:')))
      )
    );
    
    // é«˜é¢¨éšªï¼šåˆ†æ•¸ 1-20ï¼ˆå®˜æ–¹ Attack ç´šåˆ¥ï¼‰
    const highRiskLogs = xssLogs.filter(log => 
      isValidWAFScore(log.wafXSSScore) && 
      log.wafXSSScore >= 1 && 
      log.wafXSSScore <= RECOMMENDED_THRESHOLDS.HIGH  // <= 20
    );
    
    return {
      count: xssLogs.length,
      highRisk: highRiskLogs.length,
      topIPs: this.getTopN(xssLogs, 'clientIP', 10),
      topTargets: this.getTopN(xssLogs, 'requestURI', 10),
      topCountries: this.getTopN(xssLogs, 'clientCountry', 5),
      affectedAssets: new Set(xssLogs.map(log => log.edgeHost).filter(h => h)).size,
      avgScore: calculateValidAvgScore(xssLogs, 'wafXSSScore')  // âœ… åªè¨ˆç®—æœ‰æ•ˆåˆ†æ•¸
    };
  }
  
  // åˆ†æ RCE æ”»æ“Šï¼ˆä½¿ç”¨ Cloudflare å®˜æ–¹æ¨™æº–ï¼‰
  analyzeRCEAttacks(logEntries) {
    const rceLogs = logEntries.filter(log => 
      !isCloudflareInternalEndpoint(log.requestURI) &&  // âœ… æ’é™¤å…§éƒ¨ç«¯é»
      (
        (isValidWAFScore(log.wafRCEScore) && log.wafRCEScore <= 50) ||  // âœ… æœ‰æ•ˆåˆ†æ•¸ 1-50
        (log.securityRule && (log.securityRule.toLowerCase().includes('rce') || 
                             log.securityRule.toLowerCase().includes('remote code')))
      )
    );
    
    // é«˜é¢¨éšªï¼šåˆ†æ•¸ 1-20ï¼ˆå®˜æ–¹ Attack ç´šåˆ¥ï¼‰
    const highRiskLogs = rceLogs.filter(log => 
      isValidWAFScore(log.wafRCEScore) && 
      log.wafRCEScore >= 1 && 
      log.wafRCEScore <= RECOMMENDED_THRESHOLDS.HIGH  // <= 20
    );
    
    return {
      count: rceLogs.length,
      highRisk: highRiskLogs.length,
      topIPs: this.getTopN(rceLogs, 'clientIP', 10),
      topTargets: this.getTopN(rceLogs, 'requestURI', 10),
      topCountries: this.getTopN(rceLogs, 'clientCountry', 5),
      affectedAssets: new Set(rceLogs.map(log => log.edgeHost).filter(h => h)).size,
      avgScore: calculateValidAvgScore(rceLogs, 'wafRCEScore')  // âœ… åªè¨ˆç®—æœ‰æ•ˆåˆ†æ•¸
    };
  }
  
  // åˆ†ææƒ¡æ„æ©Ÿå™¨äººæµé‡
  analyzeBotTraffic(logEntries) {
    // æª¢æ¸¬æ©Ÿå™¨äººç‰¹å¾µï¼šUser-Agentã€è«‹æ±‚æ¨¡å¼
    const botLogs = logEntries.filter(log => {
      const ua = (log.userAgent || '').toLowerCase();
      return ua.includes('bot') || 
             ua.includes('crawler') || 
             ua.includes('spider') ||
             ua.includes('python') ||
             ua.includes('curl') ||
             ua.includes('wget');
    });
    
    return {
      count: botLogs.length,
      topIPs: this.getTopN(botLogs, 'clientIP', 10),
      topCountries: this.getTopN(botLogs, 'clientCountry', 5),
      topASNs: this.getTopN(botLogs, 'clientASN', 5),
      affectedAssets: new Set(botLogs.map(log => log.edgeHost).filter(h => h)).size
    };
  }
  
  // åˆ†æè·¯å¾‘éæ­·æ”»æ“Š
  analyzePathTraversal(logEntries) {
    const pathTraversalLogs = logEntries.filter(log => {
      const uri = (log.requestURI || '').toLowerCase();
      return uri.includes('../') || 
             uri.includes('..\\') || 
             uri.includes('%2e%2e') ||
             uri.includes('traversal');
    });
    
    const sensitiveFiles = this.extractSensitiveFiles(pathTraversalLogs);
    
    return {
      count: pathTraversalLogs.length,
      topIPs: this.getTopN(pathTraversalLogs, 'clientIP', 10),
      sensitiveFiles: sensitiveFiles,
      affectedAssets: new Set(pathTraversalLogs.map(log => log.edgeHost).filter(h => h)).size
    };
  }
  
  // åˆ†æç•°å¸¸ User-Agent
  analyzeAbnormalUA(logEntries) {
    const abnormalUALogs = logEntries.filter(log => {
      const ua = log.userAgent || '';
      
      // ç©º UA
      if (ua.length === 0) return true;
      
      // ç•°å¸¸çŸ­
      if (ua.length < 10) return true;
      
      // ç•°å¸¸é•·
      if (ua.length > 500) return true;
      
      // æ˜é¡¯çš„æƒæå·¥å…·
      const lowerUA = ua.toLowerCase();
      const scanTools = ['sqlmap', 'nmap', 'nikto', 'masscan', 'zap', 'burp', 'metasploit'];
      return scanTools.some(tool => lowerUA.includes(tool));
    });
    
    return {
      count: abnormalUALogs.length,
      topIPs: this.getTopN(abnormalUALogs, 'clientIP', 10),
      examples: [...new Set(abnormalUALogs.map(log => log.userAgent))].slice(0, 5),
      affectedAssets: new Set(abnormalUALogs.map(log => log.edgeHost).filter(h => h)).size
    };
  }
  
  // åˆ†æåœ°ç†åˆ†ä½ˆ
  analyzeGeoDistribution(logEntries) {
    return {
      topCountries: this.getTopN(logEntries, 'clientCountry', 10),
      topIPs: this.getTopN(logEntries, 'clientIP', 20),
      topASNs: this.getTopN(logEntries, 'clientASN', 10)
    };
  }
  
  // åˆ†æå—å½±éŸ¿è³‡ç”¢
  analyzeAffectedAssets(logEntries) {
    const assetCounts = this.getTopN(logEntries, 'edgeHost', 20);
    return {
      totalAssets: new Set(logEntries.map(log => log.edgeHost).filter(h => h)).size,
      topAssets: assetCounts
    };
  }
  
  // æå–æ•æ„Ÿæª”æ¡ˆ
  extractSensitiveFiles(logs) {
    const sensitivePatterns = [
      '.env', 'config', '.git', 'wp-config', 'web.config', 
      'admin', '.htaccess', '.htpasswd', 'id_rsa', 'authorized_keys',
      '.aws', '.ssh', 'database.yml', 'settings.py'
    ];
    const found = new Set();
    
    logs.forEach(log => {
      const uri = log.requestURI || '';
      sensitivePatterns.forEach(pattern => {
        if (uri.toLowerCase().includes(pattern)) {
          found.add(uri);
        }
      });
    });
    
    return Array.from(found).slice(0, 15);
  }
  
  // ç”Ÿæˆ AI åˆ†æ Promptï¼ˆå®Œå…¨åŸºæ–¼çœŸå¯¦è³‡æ–™ï¼‰
  generateAIPrompt(analysisData) {
    const { sqlInjection, xssAttacks, rceAttacks, botTraffic, pathTraversal, abnormalUA, geoAnalysis, assetAnalysis, totalEvents, timeRange } = analysisData;
    
    // æª¢æŸ¥æ˜¯å¦æœ‰ä»»ä½•æ”»æ“Šäº‹ä»¶
    const hasAnyAttack = sqlInjection.count > 0 || xssAttacks.count > 0 || rceAttacks.count > 0 || 
                         botTraffic.count > 0 || pathTraversal.count > 0 || abnormalUA.count > 0;
    
    // å¦‚æœæ²’æœ‰ä»»ä½•æ”»æ“Šäº‹ä»¶ï¼Œè¿”å›å®‰å…¨ç‹€æ…‹çš„ prompt
    if (!hasAnyAttack) {
      return `
ä½œç‚ºè³‡å®‰å°ˆå®¶ï¼Œè«‹åŸºæ–¼ä»¥ä¸‹ Cloudflare WAF æ—¥èªŒåˆ†æçµæœï¼Œç”Ÿæˆé¢¨éšªè©•ä¼°å ±å‘Šã€‚

**è³‡æ–™ä¾†æº**
- ç´¢å¼•: ${this.elkConfig.elasticsearch.index}
- æ™‚é–“ç¯„åœ: ${timeRange.start} ~ ${timeRange.end}
- ç¸½äº‹ä»¶æ•¸: ${totalEvents.toLocaleString()}

**åˆ†æçµæœï¼šæœªæª¢æ¸¬åˆ°ä»»ä½•å®‰å…¨å¨è„…**

åœ¨æŒ‡å®šæ™‚é–“ç¯„åœå…§ï¼Œç¶“é Cloudflare WAF çš„å®Œæ•´åˆ†æå¾Œï¼Œæœªæª¢æ¸¬åˆ°ä»»ä½• SQL æ³¨å…¥ã€XSSã€RCEã€è·¯å¾‘éæ­·æ”»æ“Šæˆ–ç•°å¸¸æ©Ÿå™¨äººæµé‡ã€‚æ‰€æœ‰è«‹æ±‚å‡é€šéå®‰å…¨æª¢æŸ¥ã€‚

**è«‹ç”Ÿæˆ JSON æ ¼å¼çš„é¢¨éšªå ±å‘Šï¼ˆåš´æ ¼éµå®ˆä»¥ä¸‹æ ¼å¼ï¼‰ï¼š**

\`\`\`json
{
  "risks": []
}
\`\`\`

**é‡è¦è¦å‰‡**ï¼š
1. ç”±æ–¼æ²’æœ‰æª¢æ¸¬åˆ°ä»»ä½•æ”»æ“Šï¼Œrisks é™£åˆ—æ‡‰è©²ç‚ºç©ºé™£åˆ— []
2. ä¸è¦ç”Ÿæˆä»»ä½•è™›æ§‹çš„é¢¨éšªé …ç›®
3. è«‹ä»¥ç¹é«”ä¸­æ–‡å›ç­”ï¼Œ**å‹™å¿…è¼¸å‡ºç´” JSON æ ¼å¼**ï¼Œä¸è¦æœ‰ markdown æˆ–å…¶ä»–æ ¼å¼ç¬¦è™Ÿ
`;
    }
    
    // æ§‹å»ºæ”»æ“Šé¡å‹åˆ—è¡¨ï¼ˆåªåŒ…å«æœ‰æ•¸æ“šçš„é¡å‹ï¼‰
    const attackSections = [];
    let sectionIndex = 1;
    
    // SQL æ³¨å…¥æ”»æ“Š
    if (sqlInjection.count > 0) {
      attackSections.push(`
${sectionIndex}. SQL æ³¨å…¥æ”»æ“Š
   - æª¢æ¸¬æ¬¡æ•¸: ${sqlInjection.count}
   - é«˜é¢¨éšª (åˆ†æ•¸<10): ${sqlInjection.highRisk}
   - å¹³å‡ WAF åˆ†æ•¸: ${sqlInjection.avgScore}
   - å—å½±éŸ¿è³‡ç”¢: ${sqlInjection.affectedAssets}
   - Top 5 ä¾†æºIP: ${sqlInjection.topIPs.slice(0, 5).map(ip => `${ip.item} (${ip.count}æ¬¡)`).join(', ') || 'ç„¡'}
   - Top 5 ä¾†æºåœ‹å®¶: ${sqlInjection.topCountries.map(c => `${c.item} (${c.count}æ¬¡)`).join(', ') || 'ç„¡'}
   - Top 5 æ”»æ“Šç›®æ¨™: ${sqlInjection.topTargets.slice(0, 5).map(t => t.item).join(', ') || 'ç„¡'}`);
      sectionIndex++;
    }
    
    // XSS æ”»æ“Š
    if (xssAttacks.count > 0) {
      attackSections.push(`
${sectionIndex}. XSS æ”»æ“Š
   - æª¢æ¸¬æ¬¡æ•¸: ${xssAttacks.count}
   - é«˜é¢¨éšª (åˆ†æ•¸<10): ${xssAttacks.highRisk}
   - å¹³å‡ WAF åˆ†æ•¸: ${xssAttacks.avgScore}
   - å—å½±éŸ¿è³‡ç”¢: ${xssAttacks.affectedAssets}
   - Top 5 ä¾†æºIP: ${xssAttacks.topIPs.slice(0, 5).map(ip => `${ip.item} (${ip.count}æ¬¡)`).join(', ') || 'ç„¡'}`);
      sectionIndex++;
    }
    
    // RCE æ”»æ“Š
    if (rceAttacks.count > 0) {
      attackSections.push(`
${sectionIndex}. RCE æ”»æ“Š
   - æª¢æ¸¬æ¬¡æ•¸: ${rceAttacks.count}
   - é«˜é¢¨éšª (åˆ†æ•¸<10): ${rceAttacks.highRisk}
   - å¹³å‡ WAF åˆ†æ•¸: ${rceAttacks.avgScore}
   - å—å½±éŸ¿è³‡ç”¢: ${rceAttacks.affectedAssets}
   - Top 5 ä¾†æºIP: ${rceAttacks.topIPs.slice(0, 5).map(ip => `${ip.item} (${ip.count}æ¬¡)`).join(', ') || 'ç„¡'}`);
      sectionIndex++;
    }
    
    // æƒ¡æ„æ©Ÿå™¨äººæµé‡
    if (botTraffic.count > 0) {
      attackSections.push(`
${sectionIndex}. æƒ¡æ„æ©Ÿå™¨äººæµé‡
   - æª¢æ¸¬æ¬¡æ•¸: ${botTraffic.count}
   - å—å½±éŸ¿è³‡ç”¢: ${botTraffic.affectedAssets}
   - Top 5 ä¾†æºåœ‹å®¶: ${botTraffic.topCountries.map(c => `${c.item} (${c.count}æ¬¡)`).join(', ') || 'ç„¡'}
   - Top 5 ASN: ${botTraffic.topASNs.map(asn => `${asn.item} (${asn.count}æ¬¡)`).join(', ') || 'ç„¡'}`);
      sectionIndex++;
    }
    
    // è·¯å¾‘éæ­·æ”»æ“Š
    if (pathTraversal.count > 0) {
      attackSections.push(`
${sectionIndex}. è·¯å¾‘éæ­·æ”»æ“Š
   - æª¢æ¸¬æ¬¡æ•¸: ${pathTraversal.count}
   - å—å½±éŸ¿è³‡ç”¢: ${pathTraversal.affectedAssets}
   - æ•æ„Ÿæª”æ¡ˆæ¢æ¸¬: ${pathTraversal.sensitiveFiles.slice(0, 5).join(', ') || 'ç„¡'}
   - Top 5 ä¾†æºIP: ${pathTraversal.topIPs.slice(0, 5).map(ip => `${ip.item} (${ip.count}æ¬¡)`).join(', ') || 'ç„¡'}`);
      sectionIndex++;
    }
    
    // ç•°å¸¸ User-Agent
    if (abnormalUA.count > 0) {
      attackSections.push(`
${sectionIndex}. ç•°å¸¸ User-Agent
   - æª¢æ¸¬æ¬¡æ•¸: ${abnormalUA.count}
   - å—å½±éŸ¿è³‡ç”¢: ${abnormalUA.affectedAssets}
   - ç¯„ä¾‹: ${abnormalUA.examples.slice(0, 3).map(ua => `"${ua}"`).join(', ') || 'ç„¡'}`);
      sectionIndex++;
    }
    
    return `
ä½œç‚ºè³‡å®‰å°ˆå®¶ï¼Œè«‹åŸºæ–¼ä»¥ä¸‹ Cloudflare WAF æ—¥èªŒåˆ†æçµæœï¼Œç”Ÿæˆé¢¨éšªè©•ä¼°å ±å‘Šã€‚

**è³‡æ–™ä¾†æº**
- ç´¢å¼•: ${this.elkConfig.elasticsearch.index}
- æ™‚é–“ç¯„åœ: ${timeRange.start} ~ ${timeRange.end}
- ç¸½äº‹ä»¶æ•¸: ${totalEvents.toLocaleString()}

**é‡è¦ï¼šCloudflare WAF Attack Score å®˜æ–¹æ¨™æº–**
ï¼ˆä¾†æºï¼šCloudflare å®˜æ–¹æ–‡ä»¶ - traffic-detections.mdï¼‰

- WAF åˆ†æ•¸ç¯„åœ: 1-99
- åˆ†æ•¸è¶Šä½è¶Šå±éšªï¼åˆ†æ•¸ 1 = å¹¾ä¹ç¢ºå®šæ˜¯æƒ¡æ„çš„ï¼Œåˆ†æ•¸ 99 = å¾ˆå¯èƒ½æ˜¯æ­£å¸¸æµé‡

**å®˜æ–¹åˆ†é¡æ¨™æº–ï¼š**
- 1-20: æ”»æ“Š (Attack) - å¹¾ä¹ç¢ºå®šæ˜¯æƒ¡æ„æ”»æ“Š
- 21-50: å¯èƒ½æ”»æ“Š (Likely Attack) - å¯èƒ½æ˜¯æ”»æ“Šï¼Œä½†æ­¤ç¯„åœå®¹æ˜“æœ‰èª¤å ±
- 51-80: å¯èƒ½æ­£å¸¸ (Likely Clean) - å¯èƒ½æ˜¯æ­£å¸¸æµé‡
- 81-99: æ­£å¸¸ (Clean) - å¾ˆå¯èƒ½æ˜¯æ­£å¸¸æµé‡
- 0 æˆ– 100: æœªè©•åˆ† (Unscored) - Cloudflare WAF æ²’æœ‰è©•åˆ†æ­¤è«‹æ±‚

**é‡è¦èªªæ˜ï¼š**
- åˆ†æ•¸ 0 æˆ– 100 ä»£è¡¨ã€Œæœªè©•åˆ†ã€ï¼Œä¸ä»£è¡¨æ”»æ“Š
- Cloudflare å®˜æ–¹å»ºè­°ä½¿ç”¨ <= 20 ä½œç‚ºé˜»æ“‹é–¾å€¼
- åˆ†æ•¸ 21-50 å®¹æ˜“èª¤å ±ï¼Œéœ€çµåˆå…¶ä»–æ¢ä»¶åˆ¤æ–·
- æ‰€æœ‰ /cdn-cgi/* è·¯å¾‘éƒ½æ˜¯ Cloudflare å…§éƒ¨æœå‹™ï¼Œå·²è‡ªå‹•éæ¿¾

**æ”»æ“Šçµ±è¨ˆï¼ˆåŸºæ–¼çœŸå¯¦ Cloudflare æ—¥èªŒï¼‰**
${attackSections.join('\n')}

**åœ°ç†èˆ‡è³‡ç”¢åˆ†æ**
- Top 10 æ”»æ“Šä¾†æºåœ‹å®¶: ${geoAnalysis.topCountries.slice(0, 10).map(c => `${c.item} (${c.count}æ¬¡)`).join(', ') || 'ç„¡'}
- Top 10 æ”»æ“Šä¾†æºIP: ${geoAnalysis.topIPs.slice(0, 10).map(ip => `${ip.item} (${ip.count}æ¬¡)`).join(', ') || 'ç„¡'}
- å—å½±éŸ¿è³‡ç”¢ç¸½æ•¸: ${assetAnalysis.totalAssets}
- Top 5 è¢«æ”»æ“Šè³‡ç”¢: ${assetAnalysis.topAssets.slice(0, 5).map(a => `${a.item} (${a.count}æ¬¡)`).join(', ') || 'ç„¡'}

**è«‹ç”Ÿæˆ JSON æ ¼å¼çš„é¢¨éšªå ±å‘Šï¼ˆåš´æ ¼éµå®ˆä»¥ä¸‹æ ¼å¼ï¼‰ï¼š**

\`\`\`json
{
  "risks": [
    {
      "id": "æ”»æ“Šé¡å‹-æ™‚é–“æˆ³ï¼ˆä¾‹å¦‚ï¼šsql-injection-surge-${Date.now()}ï¼‰",
      "title": "é¢¨éšªæ¨™é¡Œï¼ˆä¾‹å¦‚ï¼šSQL æ³¨å…¥æ”»æ“Šæ¿€å¢ï¼‰",
      "severity": "critical" | "high" | "medium" | "low",
      "openIssues": æª¢æ¸¬æ¬¡æ•¸ï¼ˆæ•¸å­—é¡å‹ï¼‰,
      "resolvedIssues": 0,
      "affectedAssets": å—å½±éŸ¿è³‡ç”¢æ•¸ï¼ˆæ•¸å­—é¡å‹ï¼‰,
      "tags": ["Exploit In Wild", "Internet Exposed", "Confirmed Exploitable"] ç­‰æ¨™ç±¤ï¼ˆé™£åˆ—ï¼Œæ ¹æ“šå¯¦éš›æƒ…æ³é¸æ“‡ï¼‰,
      "description": "è©³ç´°æè¿°ï¼ˆ200-300å­—ï¼‰ï¼ŒåŒ…å«æ”»æ“Šæ‰‹æ³•ã€ç›®æ¨™ã€å½±éŸ¿ç¯„åœ",
      "aiInsight": "AI æ·±åº¦åˆ†æï¼ˆ100-150å­—ï¼‰- æ ¹æ“šå¯¦éš›æª¢æ¸¬æ•¸æ“šåˆ†ææ”»æ“Šè¶¨å‹¢ã€ç›®æ¨™ç‰¹å¾µã€å¨è„…ç­‰ç´šï¼Œæä¾›å…·é«”çš„æ™‚é–“ã€åœ°ç†ã€æ•¸é‡è³‡è¨Šï¼Œé¿å…ä½¿ç”¨æ¨¡ç³Šèªè¨€",
      "createdDate": "Apr 6, 2025",
      "updatedDate": "Apr 10, 2025",
      "exploitInWild": true | false ï¼ˆæ ¹æ“šæ”»æ“Šæ¨¡å¼åˆ¤æ–·ï¼‰,
      "internetExposed": true ï¼ˆCloudflare è³‡æ–™é è¨­ç‚º trueï¼‰,
      "confirmedExploitable": true | false ï¼ˆæ ¹æ“š WAF åˆ†æ•¸<10 åˆ¤æ–·ï¼‰,
      "cveId": "CVE-XXXX-XXXX ï¼ˆå¦‚é©ç”¨ï¼Œå¦å‰‡ä¸åŒ…å«æ­¤æ¬„ä½ï¼‰",
      "recommendations": [
        {
          "title": "å»ºè­°æ¨™é¡Œï¼ˆå…·é«”ã€å¯åŸ·è¡Œï¼‰",
          "description": "å»ºè­°æè¿°ï¼ˆ150-200å­—ï¼‰",
          "priority": "high" | "medium" | "low"
        }
      ]
    }
  ]
}
\`\`\`

**é¢¨éšªç­‰ç´šåˆ¤å®šæ¨™æº–ï¼ˆåŸºæ–¼ Cloudflare å®˜æ–¹æ¨™æº–ï¼‰**ï¼š
- **Critical**: WAFåˆ†æ•¸ 1-10ï¼ˆæ¥µåº¦å±éšªï¼‰ æˆ– é«˜é¢¨éšªæ¬¡æ•¸>500 æˆ– æª¢æ¸¬åˆ°åš´é‡ CVE
- **High**: WAFåˆ†æ•¸ 11-20ï¼ˆå®˜æ–¹ Attack ç´šåˆ¥ï¼‰ æˆ– æª¢æ¸¬æ¬¡æ•¸>100 æˆ– å—å½±éŸ¿è³‡ç”¢>10
- **Medium**: WAFåˆ†æ•¸ 21-50ï¼ˆå®˜æ–¹ Likely Attack ç´šåˆ¥ï¼Œä½†æ³¨æ„èª¤å ±ï¼‰ æˆ– æª¢æ¸¬æ¬¡æ•¸>50
- **Low**: WAFåˆ†æ•¸ 51-99ï¼ˆå®˜æ–¹ Likely Clean/Clean ç´šåˆ¥ï¼‰ æˆ– æª¢æ¸¬æ¬¡æ•¸<50

**æ³¨æ„ï¼šåªæœ‰ WAF åˆ†æ•¸åœ¨ 1-99 ä¹‹é–“æ‰æ˜¯æœ‰æ•ˆåˆ†æ•¸ï¼Œåˆ†æ•¸ 0 æˆ– 100 ä»£è¡¨æœªè©•åˆ†**

**æ¨™ç±¤åˆ¤å®šæ¨™æº–**ï¼š
- "Exploit In Wild": æª¢æ¸¬åˆ°å·²çŸ¥æ”»æ“Šæ¨¡å¼æˆ–æƒæå·¥å…·
- "Internet Exposed": æ‰€æœ‰ Cloudflare æµé‡ï¼ˆé è¨­ trueï¼‰
- "Confirmed Exploitable": WAFåˆ†æ•¸<10 æˆ–æœ‰æˆåŠŸåˆ©ç”¨è·¡è±¡

**é‡è¦è¦å‰‡**ï¼š
1. âš ï¸ **é—œéµè¦å‰‡**ï¼šåªç”Ÿæˆä¸Šé¢ã€Œæ”»æ“Šçµ±è¨ˆã€ä¸­æ˜ç¢ºåˆ—å‡ºçš„æ”»æ“Šé¡å‹
2. âš ï¸ **çµ•å°ç¦æ­¢**ï¼šä¸è¦ç”Ÿæˆä»»ä½•åœ¨ã€Œæ”»æ“Šçµ±è¨ˆã€ä¸­æœªåˆ—å‡ºçš„æ”»æ“Šé¡å‹
3. âš ï¸ **åš´æ ¼è¦æ±‚**ï¼šå¦‚æœæŸå€‹æ”»æ“Šé¡å‹çš„æª¢æ¸¬æ¬¡æ•¸ç‚º 0ï¼Œè©²é¡å‹ä¸æœƒå‡ºç¾åœ¨ã€Œæ”»æ“Šçµ±è¨ˆã€ä¸­ï¼Œä¹Ÿçµ•å°ä¸è¦åœ¨ risks ä¸­ç”Ÿæˆ
4. æ¯å€‹é¢¨éšªè‡³å°‘æä¾› 2-3 å€‹å…·é«”å»ºè­°
5. å»ºè­°å¿…é ˆé‡å° Cloudflare WAF é…ç½®å’Œé˜²è­·æªæ–½
6. æè¿°è¦å…·é«”æåˆ°æª¢æ¸¬åˆ°çš„æ”»æ“Šç‰¹å¾µ
7. âš ï¸ **ç‰¹åˆ¥æ³¨æ„**ï¼šå·²è‡ªå‹•éæ¿¾ Cloudflare å…§éƒ¨ç«¯é»ï¼ˆ/cdn-cgi/*ï¼‰ï¼Œæ‰€æœ‰çµ±è¨ˆæ•¸æ“šå‡ç‚ºçœŸå¯¦çš„å¤–éƒ¨è«‹æ±‚
8. âš ï¸ **ç‰¹åˆ¥æ³¨æ„**ï¼šå·²æ’é™¤æœªè©•åˆ†è«‹æ±‚ï¼ˆWAFåˆ†æ•¸0æˆ–100ï¼‰ï¼Œåªåˆ†ææœ‰æ•ˆåˆ†æ•¸ï¼ˆ1-99ï¼‰çš„è«‹æ±‚

**AI Insight ç”Ÿæˆè¦å‰‡**ï¼š
- å¿…é ˆåŒ…å«å…·é«”æ•¸å­—ï¼ˆæª¢æ¸¬æ¬¡æ•¸ã€ä¾†æºåœ‹å®¶ã€å—å½±éŸ¿è³‡ç”¢æ•¸ï¼‰
- å¿…é ˆæåˆ°å¯¦éš›çš„æ”»æ“Šä¾†æºï¼ˆTop IPã€åœ‹å®¶ã€ASNï¼‰
- å¿…é ˆåˆ†ææ”»æ“Šç›®æ¨™çš„ç‰¹å¾µï¼ˆä¾‹å¦‚ï¼šä¸»è¦é‡å°å“ªäº› URIï¼‰
- å¿…é ˆèªªæ˜ WAF åˆ†æ•¸ç­‰ç´šï¼ˆAttack/Likely Attack/Cleanï¼‰
- å¦‚æœæœ‰æ˜é¡¯çš„æ™‚é–“è¶¨å‹¢ï¼Œè¦å…·é«”èªªæ˜
- ç¯„ä¾‹æ ¼å¼ï¼šã€Œåœ¨éå» XX å°æ™‚å…§æª¢æ¸¬åˆ° N æ¬¡ XX æ”»æ“Šå˜—è©¦ï¼Œå…¶ä¸­ M æ¬¡ç‚ºé«˜é¢¨éšªï¼ˆWAF åˆ†æ•¸ 1-20ï¼Œå±¬æ–¼å®˜æ–¹å®šç¾©çš„ Attack ç´šåˆ¥ï¼‰ã€‚ä¸»è¦æ”»æ“Šä¾†æºç‚º XX åœ‹å®¶ï¼ˆN æ¬¡ï¼‰ï¼Œé›†ä¸­æ”»æ“Š N å€‹è³‡ç”¢ã€‚å¹³å‡ WAF åˆ†æ•¸ç‚º XXã€‚å»ºè­°ç«‹å³æª¢æŸ¥å—å½±éŸ¿ç«¯é»çš„ WAF è¦å‰‡è¨­å®šã€‚ã€

**ç¯„ä¾‹èªªæ˜**ï¼š
- âœ… æ­£ç¢ºï¼šè‹¥ã€Œæ”»æ“Šçµ±è¨ˆã€ä¸­åˆ—å‡ºã€Œ1. SQL æ³¨å…¥æ”»æ“Š - æª¢æ¸¬æ¬¡æ•¸: 50ã€ï¼Œå‰‡ç”Ÿæˆ SQL æ³¨å…¥çš„é¢¨éšªé …ç›®
- âŒ éŒ¯èª¤ï¼šè‹¥ã€Œæ”»æ“Šçµ±è¨ˆã€ä¸­æ²’æœ‰åˆ—å‡ºã€Œè·¯å¾‘éæ­·æ”»æ“Šã€ï¼ˆå› ç‚ºæª¢æ¸¬æ¬¡æ•¸ç‚º 0ï¼‰ï¼Œå‰‡çµ•å°ä¸è¦ç”Ÿæˆè·¯å¾‘éæ­·çš„é¢¨éšªé …ç›®
- âœ… æ­£ç¢ºï¼šåªç”Ÿæˆã€Œæ”»æ“Šçµ±è¨ˆã€ä¸­å¯¦éš›åˆ—å‡ºçš„æ”»æ“Šé¡å‹ï¼Œåºè™Ÿå¯èƒ½å¾ 1 é–‹å§‹ï¼Œä¹Ÿå¯èƒ½åªæœ‰ 2ã€3ã€4

è«‹ä»¥ç¹é«”ä¸­æ–‡å›ç­”ï¼Œ**å‹™å¿…è¼¸å‡ºç´” JSON æ ¼å¼**ï¼Œä¸è¦æœ‰ markdown æˆ–å…¶ä»–æ ¼å¼ç¬¦è™Ÿã€‚
    `.trim();
  }
  
  // ç”Ÿæˆ Fallback é¢¨éšªè³‡æ–™ï¼ˆAI è§£æå¤±æ•—æ™‚ä½¿ç”¨ï¼‰
  generateFallbackRisks(analysisData) {
    const risks = [];
    const { sqlInjection, xssAttacks, rceAttacks, botTraffic, pathTraversal, abnormalUA, assetAnalysis } = analysisData;
    
    // æ ¹æ“šå¯¦éš›è³‡æ–™ç”ŸæˆåŸºæœ¬é¢¨éšªé …ç›®
    if (sqlInjection.count > 0) {
      const topCountry = sqlInjection.topCountries[0];
      const topIP = sqlInjection.topIPs[0];
      
      risks.push({
        id: `sql-injection-${Date.now()}`,
        title: 'SQL æ³¨å…¥æ”»æ“Šæª¢æ¸¬',
        severity: sqlInjection.highRisk > 50 ? 'critical' : sqlInjection.count > 100 ? 'high' : 'medium',
        openIssues: sqlInjection.count,
        resolvedIssues: 0,
        affectedAssets: sqlInjection.affectedAssets,
        tags: sqlInjection.highRisk > 0 ? ['Internet Exposed', 'Confirmed Exploitable'] : ['Internet Exposed'],
        description: `æª¢æ¸¬åˆ° ${sqlInjection.count} æ¬¡ SQL æ³¨å…¥æ”»æ“Šå˜—è©¦ï¼Œå…¶ä¸­ ${sqlInjection.highRisk} æ¬¡ç‚ºé«˜é¢¨éšªæ”»æ“Šï¼ˆWAFåˆ†æ•¸<10ï¼‰ã€‚ä¸»è¦ä¾†æºåœ‹å®¶ï¼š${sqlInjection.topCountries.slice(0, 3).map(c => c.item).join('ã€')}ã€‚`,
        aiInsight: `åœ¨éå» 24 å°æ™‚å…§æª¢æ¸¬åˆ° ${sqlInjection.count} æ¬¡ SQL æ³¨å…¥å˜—è©¦ï¼ˆå·²æ’é™¤ Cloudflare å…§éƒ¨ç«¯é»å’Œæœªè©•åˆ†è«‹æ±‚ï¼‰ï¼Œå…¶ä¸­ ${sqlInjection.highRisk} æ¬¡å±¬æ–¼é«˜é¢¨éšªç´šåˆ¥ï¼ˆWAF åˆ†æ•¸ 1-20ï¼Œç¬¦åˆ Cloudflare å®˜æ–¹å®šç¾©çš„ Attack ç´šåˆ¥ï¼‰ã€‚ä¸»è¦æ”»æ“Šä¾†è‡ª ${topCountry?.item || 'æœªçŸ¥'}ï¼ˆ${topCountry?.count || 0} æ¬¡ï¼‰ï¼ŒTop æ”»æ“Š IP ç‚º ${topIP?.item || 'æœªçŸ¥'}ï¼ˆ${topIP?.count || 0} æ¬¡ï¼‰ã€‚å…±å½±éŸ¿ ${sqlInjection.affectedAssets} å€‹è³‡ç”¢ï¼Œå¹³å‡ WAF åˆ†æ•¸ç‚º ${sqlInjection.avgScore}${sqlInjection.avgScore <= 20 ? 'ï¼ˆAttack ç´šåˆ¥ï¼‰' : sqlInjection.avgScore <= 50 ? 'ï¼ˆLikely Attack ç´šåˆ¥ï¼Œä½†å¯èƒ½æœ‰èª¤å ±ï¼‰' : 'ï¼ˆLikely Clean/Clean ç´šåˆ¥ï¼‰'}ã€‚å»ºè­°ç«‹å³æª¢æŸ¥å—å½±éŸ¿ç«¯é»çš„ WAF è¦å‰‡ä¸¦åŠ å¼·ç›£æ§ã€‚`,
        createdDate: new Date().toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }),
        updatedDate: new Date().toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }),
        exploitInWild: sqlInjection.highRisk > 0,
        internetExposed: true,
        confirmedExploitable: sqlInjection.highRisk > 0,
        recommendations: [
          {
            title: 'å•Ÿç”¨ Cloudflare WAF SQL æ³¨å…¥é˜²è­·è¦å‰‡',
            description: 'ç«‹å³å•Ÿç”¨ä¸¦å¼·åŒ– Cloudflare WAF çš„ SQL æ³¨å…¥é˜²è­·è¦å‰‡é›†',
            priority: 'high'
          },
          {
            title: 'æª¢æŸ¥ä¸¦æ›´æ–°è³‡æ–™åº«æŸ¥è©¢',
            description: 'ä½¿ç”¨åƒæ•¸åŒ–æŸ¥è©¢é˜²æ­¢ SQL æ³¨å…¥æ”»æ“Š',
            priority: 'high'
          }
        ]
      });
    }
    
    if (xssAttacks.count > 0) {
      const topCountry = xssAttacks.topCountries[0];
      const topIP = xssAttacks.topIPs[0];
      
      risks.push({
        id: `xss-attack-${Date.now()}`,
        title: 'XSS æ”»æ“Šæª¢æ¸¬',
        severity: xssAttacks.highRisk > 30 ? 'high' : 'medium',
        openIssues: xssAttacks.count,
        resolvedIssues: 0,
        affectedAssets: xssAttacks.affectedAssets,
        tags: ['Internet Exposed', 'Confirmed Exploitable'],
        description: `æª¢æ¸¬åˆ° ${xssAttacks.count} æ¬¡è·¨ç«™è…³æœ¬æ”»æ“Šå˜—è©¦ã€‚`,
        aiInsight: `åœ¨éå» 24 å°æ™‚å…§æª¢æ¸¬åˆ° ${xssAttacks.count} æ¬¡ XSS æ”»æ“Šå˜—è©¦ï¼ˆå·²æ’é™¤ Cloudflare å…§éƒ¨ç«¯é»å’Œæœªè©•åˆ†è«‹æ±‚ï¼‰ï¼Œå…¶ä¸­ ${xssAttacks.highRisk} æ¬¡å±¬æ–¼é«˜é¢¨éšªç´šåˆ¥ï¼ˆWAF åˆ†æ•¸ 1-20ï¼Œç¬¦åˆ Cloudflare å®˜æ–¹å®šç¾©çš„ Attack ç´šåˆ¥ï¼‰ã€‚ä¸»è¦æ”»æ“Šä¾†è‡ª ${topCountry?.item || 'æœªçŸ¥'}ï¼ˆ${topCountry?.count || 0} æ¬¡ï¼‰ï¼ŒTop IP ç‚º ${topIP?.item || 'æœªçŸ¥'}ã€‚å…±å½±éŸ¿ ${xssAttacks.affectedAssets} å€‹è³‡ç”¢ï¼Œå¹³å‡ WAF åˆ†æ•¸ç‚º ${xssAttacks.avgScore}${xssAttacks.avgScore <= 20 ? 'ï¼ˆAttack ç´šåˆ¥ï¼‰' : xssAttacks.avgScore <= 50 ? 'ï¼ˆLikely Attack ç´šåˆ¥ï¼‰' : 'ï¼ˆLikely Clean/Clean ç´šåˆ¥ï¼‰'}ã€‚å»ºè­°ç«‹å³å•Ÿç”¨ CSP ä¸¦æª¢æŸ¥è¼¸å…¥é©—è­‰æ©Ÿåˆ¶ã€‚`,
        createdDate: new Date().toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }),
        updatedDate: new Date().toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }),
        exploitInWild: false,
        internetExposed: true,
        confirmedExploitable: xssAttacks.highRisk > 0,
        recommendations: [
          {
            title: 'å•Ÿç”¨ XSS é˜²è­·è¦å‰‡',
            description: 'é…ç½® Cloudflare WAF çš„ XSS é˜²è­·è¦å‰‡',
            priority: 'high'
          }
        ]
      });
    }
    
    if (botTraffic.count > 100) {
      risks.push({
        id: `bot-traffic-${Date.now()}`,
        title: 'æƒ¡æ„æ©Ÿå™¨äººæµé‡',
        severity: 'medium',
        openIssues: botTraffic.count,
        resolvedIssues: 0,
        affectedAssets: botTraffic.affectedAssets,
        tags: ['Internet Exposed'],
        description: `æª¢æ¸¬åˆ° ${botTraffic.count} æ¬¡æƒ¡æ„æ©Ÿå™¨äººæµé‡ã€‚`,
        createdDate: new Date().toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }),
        updatedDate: new Date().toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }),
        exploitInWild: false,
        internetExposed: true,
        confirmedExploitable: false,
        recommendations: [
          {
            title: 'å•Ÿç”¨ Cloudflare Bot Management',
            description: 'é…ç½®æ©Ÿå™¨äººç®¡ç†åŠŸèƒ½ä»¥è­˜åˆ¥å’Œé˜»æ“‹æƒ¡æ„æ©Ÿå™¨äºº',
            priority: 'medium'
          }
        ]
      });
    }
    
    return { risks };
  }
  
  // å·¥å…·æ–¹æ³•ï¼šå–å¾— Top N
  getTopN(logs, field, n) {
    const counts = new Map();
    logs.forEach(log => {
      const value = log[field];
      if (value !== undefined && value !== null && value !== '') {
        counts.set(value, (counts.get(value) || 0) + 1);
      }
    });
    
    return Array.from(counts.entries())
      .sort((a, b) => b[1] - a[1])
      .slice(0, n)
      .map(([item, count]) => ({ item, count }));
  }
  
  // å·¥å…·æ–¹æ³•ï¼šè¨ˆç®—å¹³å‡å€¼
  calculateAvg(logs, field) {
    const values = logs
      .map(log => log[field])
      .filter(v => v !== undefined && v !== null && !isNaN(v));
    
    if (values.length === 0) return 'N/A';
    return (values.reduce((sum, v) => sum + v, 0) / values.length).toFixed(2);
  }
  
  // ç©ºçµæœ
  getEmptyAnalysisResult() {
    return {
      sqlInjection: { count: 0, highRisk: 0, topIPs: [], topTargets: [], topCountries: [], affectedAssets: 0, avgScore: 'N/A' },
      xssAttacks: { count: 0, highRisk: 0, topIPs: [], topTargets: [], topCountries: [], affectedAssets: 0, avgScore: 'N/A' },
      rceAttacks: { count: 0, highRisk: 0, topIPs: [], topTargets: [], topCountries: [], affectedAssets: 0, avgScore: 'N/A' },
      botTraffic: { count: 0, topIPs: [], topCountries: [], topASNs: [], affectedAssets: 0 },
      pathTraversal: { count: 0, topIPs: [], sensitiveFiles: [], affectedAssets: 0 },
      abnormalUA: { count: 0, topIPs: [], examples: [], affectedAssets: 0 },
      geoAnalysis: { topCountries: [], topIPs: [], topASNs: [] },
      assetAnalysis: { totalAssets: 0, topAssets: [] },
      totalEvents: 0,
      timeRange: { start: new Date().toISOString(), end: new Date().toISOString() }
    };
  }
}

module.exports = CloudflareWAFRiskService;

