  // ç”Ÿæˆ AI åˆ†æ Promptï¼ˆåŸºæ–¼çœŸå¯¦è³‡æ–™ - å‡ç´šç‰ˆï¼‰
  generateAIPrompt(analysisData) {
    const {
      sqlInjection,
      xssAttacks,
      rceAttacks,
      botTraffic,
      pathTraversal,
      abnormalUA,
      geoAnalysis,
      assetAnalysis,
      totalEvents,
      timeRange
    } = analysisData;

    // ============================
    // ğŸ”¥ é—œéµæ”¹è®Šï¼šå‹•æ…‹æ§‹å»ºæ”»æ“Šçµ±è¨ˆ
    // ============================
    
    const attackSections = [];

    // åªæ·»åŠ æª¢æ¸¬æ¬¡æ•¸ > 0 çš„æ”»æ“Šé¡å‹
    if (sqlInjection.count > 0) {
      attackSections.push({
        type: 'SQL æ³¨å…¥æ”»æ“Š',
        data: sqlInjection,
        description: 'WAFSQLiAttackScore <= 50 æˆ– SecurityRule åŒ…å« "sql"'
      });
    }

    if (xssAttacks.count > 0) {
      attackSections.push({
        type: 'XSS è·¨ç«™è…³æœ¬æ”»æ“Š',
        data: xssAttacks,
        description: 'WAFXSSAttackScore <= 50 æˆ– SecurityRule åŒ…å« "xss"'
      });
    }

    if (rceAttacks.count > 0) {
      attackSections.push({
        type: 'RCE é ç¨‹ä»£ç¢¼åŸ·è¡Œæ”»æ“Š',
        data: rceAttacks,
        description: 'WAFRCEAttackScore <= 50 æˆ– SecurityRule åŒ…å« "rce"'
      });
    }

    if (botTraffic.count > 0) {
      attackSections.push({
        type: 'æƒ¡æ„æ©Ÿå™¨äººæµé‡',
        data: botTraffic,
        description: 'BotScore < 30 æˆ– BotTags åŒ…å« "malicious"'
      });
    }

    if (pathTraversal.count > 0) {
      attackSections.push({
        type: 'è·¯å¾‘éæ­·æ”»æ“Š',
        data: pathTraversal,
        description: 'URI åŒ…å« "../", "..\\\\", "%2e%2e" æˆ–æ•æ„Ÿæª”æ¡ˆè·¯å¾‘'
      });
    }

    if (abnormalUA.count > 0) {
      attackSections.push({
        type: 'ç•°å¸¸ User-Agent',
        data: abnormalUA,
        description: 'User-Agent é•·åº¦ç•°å¸¸æˆ–åŒ…å«æƒæå·¥å…·ç‰¹å¾µ'
      });
    }

    // ============================
    // æ§‹å»ºæ”»æ“Šçµ±è¨ˆæ–‡å­—
    // ============================
    
    let attackStatisticsText = '';
    
    if (attackSections.length === 0) {
      attackStatisticsText = `
**æœªæª¢æ¸¬åˆ°ä»»ä½•å®‰å…¨å¨è„…**

åœ¨æŒ‡å®šæ™‚é–“ç¯„åœå…§ï¼Œç¶“é Cloudflare WAF çš„å®Œæ•´åˆ†æå¾Œï¼Œæœªæª¢æ¸¬åˆ°ä»»ä½• SQL æ³¨å…¥ã€XSSã€RCEã€è·¯å¾‘éæ­·æ”»æ“Šæˆ–ç•°å¸¸æ©Ÿå™¨äººæµé‡ã€‚æ‰€æœ‰è«‹æ±‚å‡é€šéå®‰å…¨æª¢æŸ¥ã€‚

âš ï¸ **é‡è¦**ï¼šç”±æ–¼æ²’æœ‰æª¢æ¸¬åˆ°ä»»ä½•æ”»æ“Šï¼Œè«‹è¼¸å‡ºç©ºçš„ risks é™£åˆ—ï¼š
\`\`\`json
{
  "risks": []
}
\`\`\`
`;
    } else {
      attackStatisticsText = attackSections.map((section, index) => {
        const { type, data, description } = section;
        
        return `
${index + 1}. **${type}**
   - æª¢æ¸¬æ–¹å¼: ${description}
   - æª¢æ¸¬æ¬¡æ•¸: ${data.count}
   ${data.highRisk !== undefined ? `- é«˜é¢¨éšª (WAFåˆ†æ•¸ 1-20): ${data.highRisk}` : ''}
   ${data.avgScore !== undefined && data.avgScore !== 'N/A' ? `- å¹³å‡ WAF åˆ†æ•¸: ${data.avgScore}` : ''}
   - å—å½±éŸ¿è³‡ç”¢: ${data.affectedAssets}
   - Top 5 ä¾†æºIP: ${data.topIPs ? data.topIPs.slice(0, 5).map(ip => `${ip.item} (${ip.count}æ¬¡)`).join(', ') : 'ç„¡'}
   - Top 5 ä¾†æºåœ‹å®¶: ${data.topCountries ? data.topCountries.map(c => `${c.item} (${c.count}æ¬¡)`).join(', ') : 'ç„¡'}
   ${data.topTargets ? `- Top 5 æ”»æ“Šç›®æ¨™: ${data.topTargets.slice(0, 5).map(t => `${t.item} (${t.count}æ¬¡)`).join(', ')}` : ''}
   ${data.sensitiveFiles ? `- æ•æ„Ÿæª”æ¡ˆæ¢æ¸¬: ${data.sensitiveFiles.slice(0, 5).join(', ')}` : ''}
`.trim();
      }).join('\n\n');
    }

    // ============================
    // ç”Ÿæˆå®Œæ•´çš„ Prompt æ¨¡æ¿
    // ============================
    
    const promptTemplate = `
ä½ æ˜¯ä¸€ä½è³‡æ·±çš„ç¶²è·¯å®‰å…¨åˆ†æå°ˆå®¶ï¼Œå°ˆç²¾æ–¼ Cloudflare WAF æ—¥èªŒåˆ†æå’Œå¨è„…è­˜åˆ¥ã€‚

### ã€ä»»å‹™èªªæ˜ã€‘

è«‹æ ¹æ“šä»¥ä¸‹ Cloudflare WAF æ—¥èªŒæ•¸æ“šï¼Œ**è‡ªå‹•è­˜åˆ¥ä¸¦åˆ†é¡æ‰€æœ‰æ”»æ“Šé¡å‹**ï¼Œç”Ÿæˆå®Œæ•´çš„é¢¨éšªè©•ä¼°å ±å‘Šã€‚

**é‡è¦ï¼šè«‹ä¸è¦ä½¿ç”¨é è¨­çš„æ”»æ“Šé¡å‹æ¸…å–®ã€‚æ‰€æœ‰æ”»æ“Šé¡å‹éƒ½æ‡‰è©²å¾æ—¥èªŒæ•¸æ“šä¸­è‡ªå‹•è­˜åˆ¥ã€‚**

---

### ã€è³‡æ–™ä¾†æºã€‘

- **ç´¢å¼•åç¨±**: ${this.elkConfig.elasticsearch.index}
- **æ™‚é–“ç¯„åœ**: ${timeRange.start} ~ ${timeRange.end}
- **ç¸½æ—¥èªŒæ•¸**: ${totalEvents.toLocaleString()} ç­†
- **åˆ†ææ™‚é–“**: ${new Date().toISOString()}

---

### ã€Cloudflare WAF æ”»æ“Šåˆ†æ•¸ç³»çµ±ï¼ˆå®˜æ–¹æ¨™æº–ï¼‰ã€‘

**åˆ†æ•¸ç¯„åœ**: 1-99ï¼ˆåˆ†æ•¸è¶Šä½è¶Šå±éšªï¼‰

- **1-20**: Attackï¼ˆæ”»æ“Šï¼‰ - å¹¾ä¹ç¢ºå®šæ˜¯æƒ¡æ„æ”»æ“Š
- **21-50**: Likely Attackï¼ˆå¯èƒ½æ”»æ“Šï¼‰ - å¯èƒ½æ˜¯æ”»æ“Šï¼Œä½†æ­¤ç¯„åœå®¹æ˜“èª¤å ±
- **51-80**: Likely Cleanï¼ˆå¯èƒ½æ­£å¸¸ï¼‰ - å¯èƒ½æ˜¯æ­£å¸¸æµé‡
- **81-99**: Cleanï¼ˆæ­£å¸¸ï¼‰ - å¾ˆå¯èƒ½æ˜¯æ­£å¸¸æµé‡
- **100 æˆ– 0**: Unscoredï¼ˆæœªè©•åˆ†ï¼‰ - WAF æ²’æœ‰è©•åˆ†æ­¤è«‹æ±‚

**é‡è¦è¦å‰‡**:
- åˆ†æ•¸ 0 æˆ– 100 = æœªè©•åˆ†ï¼Œ**ä¸ä»£è¡¨æ”»æ“Š**ï¼Œå·²è‡ªå‹•æ’é™¤
- åªæœ‰åˆ†æ•¸ 1-99 æ‰æ˜¯æœ‰æ•ˆçš„è©•åˆ†çµæœ
- æ‰€æœ‰å…§éƒ¨ Cloudflare ç«¯é»ï¼ˆ\`/cdn-cgi/*\`ï¼‰å·²è‡ªå‹•éæ¿¾

---

### ã€æ”»æ“Šçµ±è¨ˆï¼ˆåŸºæ–¼çœŸå¯¦ Cloudflare æ—¥èªŒï¼‰ã€‘

${attackStatisticsText}

---

### ã€åœ°ç†èˆ‡è³‡ç”¢åˆ†æã€‘

- **Top 10 æ”»æ“Šä¾†æºåœ‹å®¶**: ${geoAnalysis.topCountries.slice(0, 10).map(c => `${c.item} (${c.count}æ¬¡)`).join(', ') || 'ç„¡'}
- **Top 10 æ”»æ“Šä¾†æºIP**: ${geoAnalysis.topIPs.slice(0, 10).map(ip => `${ip.item} (${ip.count}æ¬¡)`).join(', ') || 'ç„¡'}
- **å—å½±éŸ¿è³‡ç”¢ç¸½æ•¸**: ${assetAnalysis.totalAssets}
- **Top 5 è¢«æ”»æ“Šè³‡ç”¢**: ${assetAnalysis.topAssets.slice(0, 5).map(a => `${a.item} (${a.count}æ¬¡)`).join(', ') || 'ç„¡'}

---

### ã€OWASP TOP 10 2021 åˆ†é¡åƒè€ƒã€‘

åœ¨è­˜åˆ¥æ”»æ“Šé¡å‹æ™‚ï¼Œè«‹åƒè€ƒ OWASP TOP 10 2021 åˆ†é¡ï¼š

1. **A01:2021 â€“ Broken Access Control** (å­˜å–æ§åˆ¶å¤±æ•ˆ)
2. **A02:2021 â€“ Cryptographic Failures** (åŠ å¯†æ©Ÿåˆ¶å¤±æ•ˆ)
3. **A03:2021 â€“ Injection** (æ³¨å…¥æ”»æ“Š) â† SQL æ³¨å…¥ã€XSSã€å‘½ä»¤æ³¨å…¥
4. **A04:2021 â€“ Insecure Design** (ä¸å®‰å…¨è¨­è¨ˆ)
5. **A05:2021 â€“ Security Misconfiguration** (å®‰å…¨é…ç½®éŒ¯èª¤)
6. **A06:2021 â€“ Vulnerable and Outdated Components** (å±éšªæˆ–éèˆŠçš„å…ƒä»¶)
7. **A07:2021 â€“ Identification and Authentication Failures** (èªè­‰åŠé©—è­‰æ©Ÿåˆ¶å¤±æ•ˆ)
8. **A08:2021 â€“ Software and Data Integrity Failures** (è»Ÿé«”åŠè³‡æ–™å®Œæ•´æ€§å¤±æ•ˆ)
9. **A09:2021 â€“ Security Logging and Monitoring Failures** (è³‡å®‰è¨˜éŒ„åŠç›£æ§å¤±æ•ˆ)
10. **A10:2021 â€“ Server-Side Request Forgery (SSRF)** (ä¼ºæœå™¨ç«¯è«‹æ±‚å½é€ )

---

### ã€è¼¸å‡ºæ ¼å¼è¦æ±‚ã€‘

è«‹ç”Ÿæˆ **åš´æ ¼çš„ JSON æ ¼å¼** é¢¨éšªå ±å‘Šï¼š

\`\`\`json
{
  "risks": [
    {
      "id": "æ”»æ“Šé¡å‹-å”¯ä¸€è­˜åˆ¥ç¢¼-æ™‚é–“æˆ³",
      "title": "æ”»æ“Šæ¨™é¡Œï¼ˆç°¡æ½”æ˜ç¢ºï¼‰",
      "severity": "critical | high | medium | low",
      "openIssues": æª¢æ¸¬æ¬¡æ•¸ï¼ˆæ•¸å­—ï¼‰,
      "resolvedIssues": 0,
      "affectedAssets": å—å½±éŸ¿çš„å”¯ä¸€ä¸»æ©Ÿåç¨±æ•¸é‡ï¼ˆæ•¸å­—ï¼‰,
      "tags": ["Exploit In Wild", "Internet Exposed", "Confirmed Exploitable"],
      "description": "è©³ç´°æè¿°ï¼ˆ200-300å­—ï¼‰",
      "aiInsight": "AI æ·±åº¦åˆ†æï¼ˆ100-150å­—ï¼‰ï¼Œå¿…é ˆåŒ…å«å…·é«”æ•¸å­—ã€WAFåˆ†æ•¸ã€ä¾†æºã€ç›®æ¨™ã€å»ºè­°",
      "createdDate": "Apr 8, 2025",
      "updatedDate": "Apr 9, 2025",
      "exploitInWild": true | false,
      "internetExposed": true,
      "confirmedExploitable": true | false,
      "cveId": "CVE-XXXX-XXXXï¼ˆå¯é¸ï¼‰",
      "recommendations": [
        {
          "title": "å»ºè­°æ¨™é¡Œ",
          "description": "å»ºè­°æè¿°ï¼ˆ150-200å­—ï¼‰",
          "priority": "high | medium | low"
        }
      ]
    }
  ]
}
\`\`\`

---

### ã€è¼¸å‡ºè¦å‰‡ã€‘

1. âš ï¸ **é—œéµè¦å‰‡**ï¼šåªç”Ÿæˆä¸Šé¢ã€Œæ”»æ“Šçµ±è¨ˆã€ä¸­æ˜ç¢ºåˆ—å‡ºçš„æ”»æ“Šé¡å‹
2. âš ï¸ **çµ•å°ç¦æ­¢**ï¼šä¸è¦ç”Ÿæˆä»»ä½•åœ¨ã€Œæ”»æ“Šçµ±è¨ˆã€ä¸­æœªåˆ—å‡ºçš„æ”»æ“Šé¡å‹
3. âš ï¸ **åš´æ ¼è¦æ±‚**ï¼šå¦‚æœæŸå€‹æ”»æ“Šé¡å‹çš„æª¢æ¸¬æ¬¡æ•¸ç‚º 0ï¼Œè©²é¡å‹ä¸æœƒå‡ºç¾åœ¨ã€Œæ”»æ“Šçµ±è¨ˆã€ä¸­ï¼Œä¹Ÿçµ•å°ä¸è¦åœ¨ risks ä¸­ç”Ÿæˆ
4. æ¯å€‹é¢¨éšªè‡³å°‘æä¾› 2-3 å€‹å…·é«”å»ºè­°
5. aiInsight å¿…é ˆåŒ…å«å…·é«”æ•¸å­—ã€WAF åˆ†æ•¸ã€Top ä¾†æºã€Top ç›®æ¨™
6. æè¿°è¦å…·é«”æåˆ°æª¢æ¸¬åˆ°çš„æ”»æ“Šç‰¹å¾µå’Œ OWASP åˆ†é¡

---

è«‹ä»¥ç¹é«”ä¸­æ–‡å›ç­”ï¼Œ**å‹™å¿…è¼¸å‡ºç´” JSON æ ¼å¼**ï¼Œä¸è¦æœ‰ markdown æˆ–å…¶ä»–æ ¼å¼ç¬¦è™Ÿã€‚
`;

    return promptTemplate.trim();
  }

