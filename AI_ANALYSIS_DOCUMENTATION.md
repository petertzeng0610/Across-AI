# Cloudflare AI åˆ†æé é¢ - æŠ€è¡“æ–‡æª”

> ğŸ“„ **æ–‡ä»¶ç‰ˆæœ¬**: 2.0ï¼ˆç²¾ç°¡ç‰ˆï¼Œä¾›å·¥ç¨‹å¸«åˆä½µä½¿ç”¨ï¼‰  
> ğŸ“… **æ›´æ–°æ—¥æœŸ**: 2025-11-13  
> ğŸ“ **é é¢è·¯å¾‘**: `http://localhost:3000/ai-analysis/cloudflare`

---

## ğŸ“‘ ç›®éŒ„

1. [é é¢æ¦‚è¿°](#é é¢æ¦‚è¿°)
2. [API æ¶æ§‹èˆ‡åˆ†é¡](#api-æ¶æ§‹èˆ‡åˆ†é¡)
3. [AI Prompt è¨­è¨ˆé‚è¼¯](#ai-prompt-è¨­è¨ˆé‚è¼¯)
4. [æ•¸æ“šæµç¨‹](#æ•¸æ“šæµç¨‹)
5. [æ™‚é–“ç¯„åœåŠŸèƒ½](#æ™‚é–“ç¯„åœåŠŸèƒ½)
6. [API å¿«é€Ÿåƒè€ƒè¡¨](#api-å¿«é€Ÿåƒè€ƒè¡¨)
7. [ç’°å¢ƒé…ç½®èˆ‡è¨­å®š](#ç’°å¢ƒé…ç½®èˆ‡è¨­å®š)
8. [éŒ¯èª¤è™•ç†èˆ‡ Fallback æ©Ÿåˆ¶](#éŒ¯èª¤è™•ç†èˆ‡-fallback-æ©Ÿåˆ¶)
9. [ç‹€æ…‹ç®¡ç† (WAFDataContext)](#ç‹€æ…‹ç®¡ç†-wafdatacontext)
10. [åƒè€ƒè³‡æº](#åƒè€ƒè³‡æº)

---

## ğŸ“Š é é¢æ¦‚è¿°

### **é é¢åŠŸèƒ½**
Cloudflare AI åˆ†æé é¢æ˜¯ä¸€å€‹åŸºæ–¼ AI çš„å®‰å…¨å¨è„…åˆ†æå„€è¡¨æ¿ï¼Œèƒ½å¤ ï¼š
- è‡ªå‹•åˆ†æ Cloudflare WAF æ—¥èªŒ
- è­˜åˆ¥å„ç¨®é¡å‹çš„å®‰å…¨å¨è„…ï¼ˆSQL æ³¨å…¥ã€XSSã€RCEã€Bot æµé‡ç­‰ï¼‰
- æä¾›è©³ç´°çš„å¨è„…æƒ…å ±å’Œå»ºè­°æªæ–½
- æ”¯æ´å¤šç¨®æ™‚é–“ç¯„åœæŸ¥è©¢ï¼ˆ1å°æ™‚ ~ 30å¤©ï¼‰

### **æŠ€è¡“æ£§**
- **å‰ç«¯**: Next.js 14 + React + TypeScript + Tailwind CSS + Framer Motion
- **å¾Œç«¯**: Node.js + Express
- **æ•¸æ“šä¾†æº**: Elasticsearch (ELK Stack) - Cloudflare WAF Logs
- **AI æ¨¡å‹**: Google Gemini 2.0 Flash / Ollama (gemma3:4b)

---

## ğŸ”Œ API æ¶æ§‹èˆ‡åˆ†é¡

### **1. æ ¸å¿ƒ API**

#### **A. Cloudflare WAF é¢¨éšªåˆ†æ API** â­ ä¸»è¦ API

**åŸºæœ¬è³‡è¨Š**
```yaml
Method: POST
Endpoint: /api/analyze-waf-risks-cloudflare
Location: backend/index.js (è¡Œ 1530-1650)
åŠŸèƒ½: åˆ†æ Cloudflare WAF æ—¥èªŒä¸¦ç”Ÿæˆ AI å¨è„…å ±å‘Š
```

**è«‹æ±‚åƒæ•¸**
```typescript
{
  "aiProvider": "gemini" | "ollama",     // AI æœå‹™æä¾›è€…
  "apiKey": string,                      // Gemini API Keyï¼ˆé¸å¡«ï¼ŒOllama ä¸éœ€è¦ï¼‰
  "model": string,                       // AI æ¨¡å‹åç¨±
  "timeRange": string                    // æ™‚é–“ç¯„åœï¼ˆå¦‚ï¼š'24h', '7d'ï¼‰
}
```

**å¾Œç«¯å¯¦éš›æ¥æ”¶ç¨‹å¼ç¢¼**ï¼ˆ`backend/index.js` ç¬¬ 1530-1543 è¡Œï¼‰
```javascript
app.post('/api/analyze-waf-risks-cloudflare', async (req, res) => {
  try {
    const { apiKey, model = 'gemini-2.0-flash-exp', timeRange = '24h', aiProvider = 'gemini' } = req.body;
    
    // å¦‚æœä½¿ç”¨ Ollamaï¼Œä¸éœ€è¦ API Key
    if (aiProvider !== 'ollama' && !apiKey) {
      return res.status(400).json({ error: 'è«‹å…ˆè¨­å®š Gemini API Key æˆ–ä½¿ç”¨ Ollama' });
    }

    console.log(`\nğŸ” ===== é–‹å§‹ Cloudflare WAF é¢¨éšªåˆ†æ API =====`);
    console.log(`ğŸ“… æ™‚é–“ç¯„åœ: ${timeRange}`);
    console.log(`ğŸ¤– AI æä¾›è€…: ${aiProvider}`);
    console.log(`ğŸ¤– AI æ¨¡å‹: ${model}`);
    
    // å¾ŒçºŒè™•ç†...
```

**è¿”å›æ ¼å¼**
```typescript
{
  "success": boolean,
  "risks": [
    {
      "id": string,                      // å”¯ä¸€è­˜åˆ¥ç¢¼
      "title": string,                   // é¢¨éšªæ¨™é¡Œ
      "severity": "critical" | "high" | "medium" | "low",
      "openIssues": number,              // æª¢æ¸¬æ¬¡æ•¸
      "resolvedIssues": number,          // å·²è§£æ±ºæ¬¡æ•¸
      "affectedAssets": number,          // å—å½±éŸ¿è³‡ç”¢æ•¸
      "tags": string[],                  // æ¨™ç±¤é™£åˆ—
      "description": string,             // è©³ç´°æè¿°ï¼ˆ200-300å­—ï¼‰
      "aiInsight": string,               // AI æ·±åº¦åˆ†æï¼ˆ100-150å­—ï¼‰
      "createdDate": string,             // å»ºç«‹æ—¥æœŸ
      "updatedDate": string,             // æ›´æ–°æ—¥æœŸ
      "exploitInWild": boolean,          // æ˜¯å¦åœ¨é‡å¤–åˆ©ç”¨
      "internetExposed": boolean,        // æ˜¯å¦æš´éœ²æ–¼ç¶²è·¯
      "confirmedExploitable": boolean,   // æ˜¯å¦ç¢ºèªå¯åˆ©ç”¨
      "cveId": string | null,            // CVE ç·¨è™Ÿ
      "recommendations": [                // å»ºè­°æªæ–½
        {
          "title": string,
          "description": string,
          "priority": "high" | "medium" | "low"
        }
      ]
    }
  ],
  "metadata": {
    "totalEvents": number,               // â­ ELK æŸ¥è©¢åˆ°çš„ç¸½äº‹ä»¶æ•¸
    "timeRange": {
      "start": string,                   // é–‹å§‹æ™‚é–“ï¼ˆISO 8601ï¼‰
      "end": string                      // çµæŸæ™‚é–“ï¼ˆISO 8601ï¼‰
    },
    "analysisTimestamp": string          // åˆ†ææ™‚é–“æˆ³
  }
}
```

---

### **2. ç›¸é—œæœå‹™ API**

#### **A. ä¸»è¦ HTTP API**

**ç«¯é»**: `POST /api/analyze-waf-risks-cloudflare`  
**æª”æ¡ˆä½ç½®**: `backend/index.js` (ç¬¬ 1530-1655 è¡Œ)  
**åŠŸèƒ½**: Cloudflare WAF æ—¥èªŒçš„ AI é¢¨éšªåˆ†æä¸»è¦æ¥å£

**è™•ç†æµç¨‹**:
```yaml
1. æ¥æ”¶å‰ç«¯åƒæ•¸ï¼ˆapiKey, model, timeRange, aiProviderï¼‰
2. å‘¼å« CloudflareWAFRiskService.analyzeCloudflareWAF() â†’ é€é ELK MCP æŸ¥è©¢æ—¥èªŒ
3. å‘¼å« CloudflareWAFRiskService.generateAIPrompt() â†’ ç”Ÿæˆ AI åˆ†æ Prompt
4. æ ¹æ“š aiProvider é¸æ“‡ AI æœå‹™ï¼ˆGemini æˆ– Ollamaï¼‰é€²è¡Œåˆ†æ
5. è§£æ AI å›æ‡‰ï¼ˆJSON æ ¼å¼ï¼‰æˆ–ä½¿ç”¨ Fallback è³‡æ–™
6. è¿”å›é¢¨éšªæ¸…å–®èˆ‡å…ƒæ•¸æ“š
```

**ä¾è³´çš„å…§éƒ¨æœå‹™**:
- `ElkMCPClient.queryElasticsearch()` - æŸ¥è©¢ Elasticsearch æ—¥èªŒ
- `CloudflareWAFRiskService.analyzeCloudflareWAF()` - åˆ†æ WAF è³‡æ–™
- `CloudflareWAFRiskService.generateAIPrompt()` - ç”Ÿæˆ Prompt
- `CloudflareWAFRiskService.generateFallbackRisks()` - æä¾› Fallback è³‡æ–™

---

#### **B. ELK MCP æŸ¥è©¢æœå‹™**

**åŸºæœ¬è³‡è¨Š**
```yaml
Service: ElkMCPClient
Location: backend/services/elkMCPClient.js (å…± 805 è¡Œ)
åŠŸèƒ½: é€é MCP å”è­°æŸ¥è©¢ Elasticsearch æ—¥èªŒ
å”è­°æ”¯æ´: HTTPã€stdioã€proxy
```

**å®Œæ•´ API æ–¹æ³•åˆ—è¡¨**

1. **é€£æ¥ç®¡ç†**
   - `async connect()` - é€£æ¥åˆ° MCP Serverï¼ˆæ”¯æ´é‡è©¦æ©Ÿåˆ¶ï¼Œç¬¬ 202-305 è¡Œï¼‰
   - `async disconnect()` - æ–·é–‹é€£æ¥ï¼ˆç¬¬ 308-318 è¡Œï¼‰
   - `async ensureConnection()` - ç¢ºä¿é€£æ¥ç‹€æ…‹ï¼ˆç¬¬ 321-342 è¡Œï¼‰
   - `async testConnection()` - æ¸¬è©¦é€£æ¥ï¼ˆç¬¬ 749-786 è¡Œï¼‰
   - `async resetClientState()` - é‡ç½®å®¢æˆ¶ç«¯ç‹€æ…‹ï¼ˆç¬¬ 674-692 è¡Œï¼‰
   - `isConnected()` - æª¢æŸ¥é€£æ¥ç‹€æ…‹ï¼ˆç¬¬ 669-671 è¡Œï¼‰

2. **HTTP MCP å°ˆç”¨æ–¹æ³•**
   - `async createHttpTransport()` - å»ºç«‹ HTTP å‚³è¼¸ï¼ˆç¬¬ 24-33 è¡Œï¼‰
   - `async createHttpSession()` - å»ºç«‹ HTTP MCP æœƒè©±ï¼ˆç¬¬ 36-81 è¡Œï¼‰
   - `async testHttpConnection()` - æ¸¬è©¦ HTTP é€£æ¥ï¼ˆç¬¬ 84-104 è¡Œï¼‰
   - `async callHttpTool(toolName, args)` - ç›´æ¥ HTTP å·¥å…·èª¿ç”¨ï¼ˆç¬¬ 107-148 è¡Œï¼‰
   - `async listTools()` - ç²å–å·¥å…·åˆ—è¡¨ï¼ˆç¬¬ 151-199 è¡Œï¼‰

3. **æ ¸å¿ƒæŸ¥è©¢æ–¹æ³•**
   - `async queryElasticsearch(timeRange, filters)` - **ä¸»è¦æŸ¥è©¢æ¥å£**ï¼ˆç¬¬ 488-587 è¡Œï¼‰
     - åƒæ•¸: `timeRange`ï¼ˆå¦‚ '1h', '24h', '7d'ï¼‰ã€`filters`ï¼ˆå¦‚ clientIp, securityAction, minWafScoreï¼‰
     - è¿”å›: `{ total, hits: [{ id, source, timestamp }] }`
   
   - `buildElasticsearchQuery(timeRange, filters)` - å»ºæ§‹ Elasticsearch æŸ¥è©¢ï¼ˆç¬¬ 376-466 è¡Œï¼‰
   - `parseTimeRange(timeRange)` - è§£ææ™‚é–“ç¯„åœç‚ºæ¯«ç§’ï¼ˆç¬¬ 469-480 è¡Œï¼‰
   - `getRequiredFields()` - ç²å–å¿…è¦æ¬„ä½æ¸…å–®ï¼ˆç¬¬ 483-485 è¡Œï¼‰
   - `async queryWithNewInstance(timeRange, filters)` - ä½¿ç”¨æ–°å¯¦ä¾‹åŸ·è¡ŒæŸ¥è©¢ï¼ˆå›é€€æ©Ÿåˆ¶ï¼Œç¬¬ 695-746 è¡Œï¼‰

4. **å°ˆç”¨æŸ¥è©¢æ–¹æ³•**
   - `async getAttackLogs(timeRange)` - ç²å–æ”»æ“Šç›¸é—œæ—¥èªŒï¼ˆç¬¬ 590-595 è¡Œï¼‰
     - è‡ªå‹•ç¯©é¸: WAF åˆ†æ•¸ â‰¤ 80ã€å®‰å…¨å‹•ä½œ = 'block'
   
   - `async getIPActivity(clientIp, timeRange)` - ç²å–ç‰¹å®š IP æ´»å‹•ï¼ˆç¬¬ 598-602 è¡Œï¼‰
   
   - `async getSecurityStats(timeRange)` - ç²å–å®‰å…¨äº‹ä»¶çµ±è¨ˆï¼ˆç¬¬ 605-666 è¡Œï¼‰
     - è¿”å›èšåˆçµ±è¨ˆ: å®‰å…¨å‹•ä½œã€ä¾†æºåœ‹å®¶ã€ä¾†æº IPã€WAF åˆ†æ•¸çµ±è¨ˆ

5. **å¿«é€Ÿæª¢æ¸¬æ–¹æ³•**
   - `async quickConnectionTest()` - å¿«é€Ÿé€£æ¥æ¸¬è©¦ï¼ˆä¸æ‹‹å‡ºéŒ¯èª¤ï¼Œç¬¬ 345-373 è¡Œï¼‰

**æ”¯æ´çš„æ™‚é–“ç¯„åœæ ¼å¼**
| æ ¼å¼ | èªªæ˜ | ç¯„ä¾‹ | è§£æç‚º |
|------|------|------|--------|
| `Xm` | X åˆ†é˜ | `30m` | 1,800,000 ms |
| `Xh` | X å°æ™‚ | `1h`, `6h`, `24h` | 3,600,000 ms / å°æ™‚ |
| `Xd` | X å¤© | `7d`, `30d` | 86,400,000 ms / å¤© |
| `auto` | è‡ªå‹•æ¨¡å¼ | `auto` | æŸ¥è©¢æœ€æ–° 1000 ç­† |

**MCP å·¥å…·èª¿ç”¨ï¼ˆé€é callHttpToolï¼‰**
| å·¥å…·åç¨± | åŠŸèƒ½ | åƒæ•¸ |
|---------|------|------|
| `list_indices` | åˆ—å‡ºæ‰€æœ‰å¯ç”¨çš„ Elasticsearch ç´¢å¼• | ç„¡ |
| `get_mappings` | ç²å–ç‰¹å®šç´¢å¼•çš„æ¬„ä½æ˜ å°„ | `{ index }` |
| `search` | åŸ·è¡Œ Elasticsearch æŸ¥è©¢ DSL | `{ index, query_body }` |
| `esql` | åŸ·è¡Œ ES\|QL æŸ¥è©¢ | `{ query }` |
| `get_shards` | ç²å–ç´¢å¼•åˆ†ç‰‡è³‡è¨Š | `{ index }` |

---

#### **C. Cloudflare WAF é¢¨éšªåˆ†ææœå‹™**

**åŸºæœ¬è³‡è¨Š**
```yaml
Service: CloudflareWAFRiskService
Location: backend/services/cloudflareWAFRiskService.js
åŠŸèƒ½: è§£æ Cloudflare æ—¥èªŒä¸¦åˆ†æå„ç¨®æ”»æ“Šé¡å‹
```

**æ ¸å¿ƒæ–¹æ³•**

1. **ä¸»è¦åˆ†ææ–¹æ³•**
```javascript
async analyzeCloudflareWAF(timeRange = '24h')
// è¿”å›å®Œæ•´çš„åˆ†æçµæœï¼ŒåŒ…å«æ‰€æœ‰æ”»æ“Šé¡å‹çµ±è¨ˆ
```

2. **æ”»æ“Šé¡å‹åˆ†ææ–¹æ³•**
```javascript
analyzeSQLInjection(logEntries)      // SQL æ³¨å…¥åˆ†æ
analyzeXSSAttacks(logEntries)        // XSS æ”»æ“Šåˆ†æ
analyzeRCEAttacks(logEntries)        // RCE æ”»æ“Šåˆ†æ
analyzeBotTraffic(logEntries)        // æƒ¡æ„æ©Ÿå™¨äººåˆ†æ
analyzePathTraversal(logEntries)     // è·¯å¾‘éæ­·åˆ†æ
analyzeAbnormalUA(logEntries)        // ç•°å¸¸ User-Agent åˆ†æ
```

3. **çµ±è¨ˆåˆ†ææ–¹æ³•**
```javascript
analyzeGeoDistribution(logEntries)   // åœ°ç†åˆ†ä½ˆåˆ†æ
analyzeAffectedAssets(logEntries)    // å—å½±éŸ¿è³‡ç”¢åˆ†æ
extractSensitiveFiles(logs)          // æ•æ„Ÿæª”æ¡ˆæ¢æ¸¬åˆ†æ
```

4. **Prompt ç”Ÿæˆæ–¹æ³•** â­
```javascript
generateAIPrompt(analysisData)       // ç”Ÿæˆ AI åˆ†æçš„ Prompt
// Location: è¡Œ 324-556
// ä½¿ç”¨å‡ç´šç‰ˆçš„å‹•æ…‹ Prompt æ¨¡æ¿
```

5. **Fallback æ–¹æ³•**
```javascript
generateFallbackRisks(analysisData)  // AI å¤±æ•—æ™‚çš„å‚™ç”¨é¢¨éšªæ•¸æ“š
```

---

#### **D. Cloudflare æ¬„ä½æ˜ å°„é…ç½®**

**åŸºæœ¬è³‡è¨Š**
```yaml
Module: CLOUDFLARE_FIELD_MAPPING
Location: cloudflare-field-mapping.js
åŠŸèƒ½: å®šç¾© Cloudflare æ—¥èªŒæ¬„ä½èˆ‡ ELK æ¬„ä½çš„æ˜ å°„é—œä¿‚
```

**ä¸»è¦æ¬„ä½åˆ†é¡**

1. **WAF æ”»æ“Šåˆ†æ•¸**
```javascript
waf_attack_score: "WAFAttackScore"        // ç¶œåˆæ”»æ“Šåˆ†æ•¸ï¼ˆ1-99ï¼‰
waf_sqli_attack_score: "WAFSQLiAttackScore"  // SQL æ³¨å…¥åˆ†æ•¸
waf_xss_attack_score: "WAFXSSAttackScore"    // XSS æ”»æ“Šåˆ†æ•¸
waf_rce_attack_score: "WAFRCEAttackScore"    // RCE æ”»æ“Šåˆ†æ•¸
```

2. **å®‰å…¨å‹•ä½œ**
```javascript
security_action: "SecurityAction"           // å®‰å…¨å‹•ä½œé™£åˆ—
security_rule_id: "SecurityRuleID"         // è§¸ç™¼çš„è¦å‰‡ ID
security_sources: "SecuritySources"         // å®‰å…¨ç”¢å“ä¾†æº
```

3. **Bot æª¢æ¸¬**
```javascript
bot_score: "BotScore"                      // Bot åˆ†æ•¸
bot_tags: "BotTags"                        // Bot é¡å‹æ¨™ç±¤
bot_detection_ids: "BotDetectionIDs"       // Bot æª¢æ¸¬ ID
```

4. **è«‹æ±‚è³‡è¨Š**
```javascript
client_ip: "ClientIP"                      // ä¾†æº IP
client_country: "ClientCountry"            // ä¾†æºåœ‹å®¶
client_request_uri: "ClientRequestURI"     // è«‹æ±‚ URI
client_request_method: "ClientRequestMethod"  // HTTP æ–¹æ³•
client_request_user_agent: "ClientRequestUserAgent"  // User-Agent
```

---

#### **E. Cloudflare æ¨™æº–é…ç½®**

**åŸºæœ¬è³‡è¨Š**
```yaml
Module: cloudflareStandards
Location: backend/config/cloudflareStandards.js
åŠŸèƒ½: å®šç¾© Cloudflare å®˜æ–¹ WAF åˆ†æ•¸æ¨™æº–å’Œåˆ†é¡è¦å‰‡
```

**WAF åˆ†æ•¸åˆ†é¡ï¼ˆå®˜æ–¹æ¨™æº–ï¼‰**
```javascript
WAF_SCORE_CLASSIFICATION = {
  attack: { min: 1, max: 20 },           // æ”»æ“Šï¼ˆå¹¾ä¹ç¢ºå®šæƒ¡æ„ï¼‰
  likely_attack: { min: 21, max: 50 },   // å¯èƒ½æ”»æ“Šï¼ˆå®¹æ˜“èª¤å ±ï¼‰
  likely_clean: { min: 51, max: 80 },    // å¯èƒ½æ­£å¸¸
  clean: { min: 81, max: 99 },           // æ­£å¸¸
  unscored: 100                          // æœªè©•åˆ†
}
```

**æ ¸å¿ƒå‡½æ•¸**
```javascript
classifyWAFScore(score)                  // åˆ†é¡ WAF åˆ†æ•¸
isValidWAFScore(score)                   // é©—è­‰åˆ†æ•¸æœ‰æ•ˆæ€§
isCloudflareInternalEndpoint(uri)        // æª¢æŸ¥æ˜¯å¦å…§éƒ¨ç«¯é»
isRealSecurityThreat(log)                // åˆ¤å®šæ˜¯å¦çœŸå¯¦å¨è„…
calculateValidAvgScore(logs, field)      // è¨ˆç®—å¹³å‡åˆ†æ•¸
```

---

## ğŸ¤– AI Prompt è¨­è¨ˆé‚è¼¯

### **Prompt çµæ§‹æ¦‚è¦½**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  AI Prompt (backend/services/cloudflareWAFRiskService.js)  â”‚
â”‚  ç¬¬ 324-556 è¡Œ                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1. ä»»å‹™èªªæ˜                                         â”‚
â”‚     â†’ å‰ç«¯ï¼šé é¢æ¨™é¡Œ + æè¿°                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  2. è³‡æ–™ä¾†æºè³‡è¨Š                                     â”‚
â”‚     â†’ å‰ç«¯ï¼šåˆ†æè³‡è¨Šå€ï¼ˆ3å¼µå¡ç‰‡ï¼‰                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  3. Cloudflare WAF æ”»æ“Šåˆ†æ•¸ç³»çµ±ï¼ˆå®˜æ–¹æ¨™æº–ï¼‰          â”‚
â”‚     â†’ å‰ç«¯ï¼šseverity åˆ¤å®šé‚è¼¯                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  4. æ”»æ“Šçµ±è¨ˆï¼ˆå‹•æ…‹ç”Ÿæˆï¼‰                             â”‚
â”‚     â†’ å‰ç«¯ï¼šé¢¨éšªè©•ä¼°å¡ç‰‡ï¼ˆé«˜/ä¸­/ä½ï¼‰                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  5. åœ°ç†èˆ‡è³‡ç”¢åˆ†æ                                   â”‚
â”‚     â†’ å‰ç«¯ï¼šåœ°ç†åˆ†ä½ˆæ¨™ç±¤                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  6. OWASP TOP 10 2021 åˆ†é¡åƒè€ƒ                      â”‚
â”‚     â†’ å‰ç«¯ï¼šdescription ä¸­çš„ OWASP åˆ†é¡             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  7. è¼¸å‡ºæ ¼å¼è¦æ±‚ï¼ˆJSON Schemaï¼‰                      â”‚
â”‚     â†’ å‰ç«¯ï¼šrisks é™£åˆ—çµæ§‹                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  8. è¼¸å‡ºè¦å‰‡ï¼ˆåš´æ ¼æ§åˆ¶ï¼‰                             â”‚
â”‚     â†’ å‰ç«¯ï¼šåªé¡¯ç¤ºå¯¦éš›æª¢æ¸¬åˆ°çš„æ”»æ“Šé¡å‹              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### **AI èˆ‡å‰ç«¯çš„æ•¸æ“šæ˜ å°„**

#### **1. åˆ†æè³‡è¨Šå€**
- **Prompt ä¾†æº**ï¼šè³‡æ–™ä¾†æºè³‡è¨Šï¼ˆcloudflare-waf-analysis-prompt.mdï¼‰
- **å‰ç«¯ä½ç½®**ï¼š`frontend/app/ai-analysis/cloudflare/page.tsx` (ç¬¬ 317-387 è¡Œ)
- **é¡¯ç¤ºå…§å®¹**ï¼šä¸‰å¼µå¡ç‰‡é¡¯ç¤ºæ™‚é–“ç¯„åœã€äº‹ä»¶ç¸½æ•¸ã€æœ€å¾Œåˆ†ææ™‚é–“
- **æ•¸æ“šä¾†æº**ï¼šAPI response çš„ `metadata` æ¬„ä½

#### **2. é¢¨éšªè©•ä¼°å¡ç‰‡**
- **Prompt ä¾†æº**ï¼šå‹•æ…‹ç”Ÿæˆçš„æ”»æ“Šçµ±è¨ˆ
- **å‰ç«¯ä½ç½®**ï¼š`page.tsx` (ç¬¬ 479-633 è¡Œ)
- **é¡¯ç¤ºå…§å®¹**ï¼šé«˜/ä¸­/ä½é¢¨éšªåˆ†é¡çµ±è¨ˆ
- **æ•¸æ“šä¾†æº**ï¼šæ ¹æ“š `risks[]` çš„ `severity` æ¬„ä½åˆ†é¡çµ±è¨ˆ

#### **3. è¶¨å‹¢åˆ†æè©³æƒ…**
- **Prompt è¼¸å‡º**ï¼šæ¯å€‹é¢¨éšªçš„è©³ç´°è³‡è¨Šï¼ˆtitle, tags, description, aiInsight, recommendationsï¼‰
- **å‰ç«¯ä½ç½®**ï¼š`page.tsx` (ç¬¬ 636-734 è¡Œ)
- **é¡¯ç¤ºå…§å®¹**ï¼šé¸ä¸­é¢¨éšªçš„å®Œæ•´è³‡è¨Šï¼ŒåŒ…å« AI æ·±åº¦åˆ†æ

#### **4. åŸ·è¡Œå»ºè­°**
- **Prompt è¼¸å‡º**ï¼šæ¯å€‹é¢¨éšªçš„ `recommendations[]` é™£åˆ—
- **å‰ç«¯ä½ç½®**ï¼š`page.tsx` (ç¬¬ 737-850 è¡Œ)
- **é¡¯ç¤ºå…§å®¹**ï¼šå…·é«”çš„ä¿®å¾©å»ºè­°ï¼Œä¾å„ªå…ˆç´šæ’åº

#### **5. Severity åˆ¤å®šé‚è¼¯**
- **ä¾æ“š**ï¼šCloudflare WAF æ”»æ“Šåˆ†æ•¸ç³»çµ±ï¼ˆ1-20=æ”»æ“Š, 21-50=å¯èƒ½æ”»æ“Š, 51-80=å¯èƒ½æ­£å¸¸, 81-99=æ­£å¸¸ï¼‰
- **å‰ç«¯å¯¦ç¾**ï¼šæ ¹æ“š `severity` é¡¯ç¤ºä¸åŒé¡è‰²ï¼ˆç´…/é»ƒ/è—ï¼‰
- **æ–¹æ³•ä½ç½®**ï¼š`getSeverityColor()` å’Œ `getSeverityBadgeColor()` å‡½æ•¸

---

## ğŸ”„ æ•¸æ“šæµç¨‹

### **å®Œæ•´æµç¨‹åœ–**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç”¨æˆ¶è¨ªå•é é¢                                               â”‚
â”‚  http://localhost:3000/ai-analysis/cloudflare              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å‰ç«¯ (page.tsx)                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ 1. useEffect è‡ªå‹•åŸ·è¡Œ                                 â”‚ â”‚
â”‚  â”‚    - é é¢è¼‰å…¥æ™‚è§¸ç™¼                                   â”‚ â”‚
â”‚  â”‚    - é è¨­æ™‚é–“ç¯„åœï¼š24h                                â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  API è«‹æ±‚                                                   â”‚
â”‚  POST /api/analyze-waf-risks-cloudflare                    â”‚
â”‚  Body: {                                                    â”‚
â”‚    aiProvider: 'ollama',                                    â”‚
â”‚    model: 'gemma3:4b',                                      â”‚
â”‚    timeRange: '24h'                                         â”‚
â”‚  }                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å¾Œç«¯ API (backend/index.js: 1530-1650)                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Step 1: å»ºç«‹ CloudflareWAFRiskService å¯¦ä¾‹           â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                         â”‚                                   â”‚
â”‚                         â–¼                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Step 2: é€é ELK MCP æŸ¥è©¢ Cloudflare æ—¥èªŒ            â”‚ â”‚
â”‚  â”‚ - wafService.analyzeCloudflareWAF(timeRange)         â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ELK æŸ¥è©¢æœå‹™ (elkMCPClient.js)                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ 1. å»ºæ§‹ Elasticsearch æŸ¥è©¢                           â”‚ â”‚
â”‚  â”‚    - buildElasticsearchQuery(timeRange)              â”‚ â”‚
â”‚  â”‚                                                       â”‚ â”‚
â”‚  â”‚ 2. æŸ¥è©¢ Elasticsearch                                â”‚ â”‚
â”‚  â”‚    - Index: cloudflare-http-logs-*                   â”‚ â”‚
â”‚  â”‚    - æ™‚é–“ç¯„åœéæ¿¾                                     â”‚ â”‚
â”‚  â”‚                                                       â”‚ â”‚
â”‚  â”‚ 3. è¿”å›åŸå§‹æ—¥èªŒ                                       â”‚ â”‚
â”‚  â”‚    - hits: [{source: {...}}, ...]                    â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ—¥èªŒåˆ†ææœå‹™ (cloudflareWAFRiskService.js)                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ 1. è§£ææ—¥èªŒï¼ˆcloudflare-field-mapping.jsï¼‰           â”‚ â”‚
â”‚  â”‚    - parseCloudflareLog(rawLog)                      â”‚ â”‚
â”‚  â”‚                                                       â”‚ â”‚
â”‚  â”‚ 2. åˆ†æå„ç¨®æ”»æ“Šé¡å‹                                   â”‚ â”‚
â”‚  â”‚    - analyzeSQLInjection(logEntries)                 â”‚ â”‚
â”‚  â”‚    - analyzeXSSAttacks(logEntries)                   â”‚ â”‚
â”‚  â”‚    - analyzeRCEAttacks(logEntries)                   â”‚ â”‚
â”‚  â”‚    - analyzeBotTraffic(logEntries)                   â”‚ â”‚
â”‚  â”‚    - analyzePathTraversal(logEntries)                â”‚ â”‚
â”‚  â”‚    - analyzeAbnormalUA(logEntries)                   â”‚ â”‚
â”‚  â”‚                                                       â”‚ â”‚
â”‚  â”‚ 3. çµ±è¨ˆåˆ†æ                                           â”‚ â”‚
â”‚  â”‚    - analyzeGeoDistribution(logEntries)              â”‚ â”‚
â”‚  â”‚    - analyzeAffectedAssets(logEntries)               â”‚ â”‚
â”‚  â”‚                                                       â”‚ â”‚
â”‚  â”‚ 4. è¿”å›åˆ†æçµæœ                                       â”‚ â”‚
â”‚  â”‚    analysisData = {                                   â”‚ â”‚
â”‚  â”‚      sqlInjection: {...},                            â”‚ â”‚
â”‚  â”‚      xssAttacks: {...},                              â”‚ â”‚
â”‚  â”‚      totalEvents: 1234,                              â”‚ â”‚
â”‚  â”‚      timeRange: {...}                                â”‚ â”‚
â”‚  â”‚    }                                                  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç”Ÿæˆ AI Prompt (cloudflareWAFRiskService.js: 324-556)     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ generateAIPrompt(analysisData)                        â”‚ â”‚
â”‚  â”‚                                                       â”‚ â”‚
â”‚  â”‚ 1. å‹•æ…‹æ§‹å»ºæ”»æ“Šçµ±è¨ˆ                                   â”‚ â”‚
â”‚  â”‚    - åªåŒ…å«æª¢æ¸¬æ¬¡æ•¸ > 0 çš„æ”»æ“Š                        â”‚ â”‚
â”‚  â”‚                                                       â”‚ â”‚
â”‚  â”‚ 2. æ·»åŠ å®˜æ–¹æ¨™æº–                                       â”‚ â”‚
â”‚  â”‚    - Cloudflare WAF åˆ†æ•¸ç³»çµ±                         â”‚ â”‚
â”‚  â”‚    - OWASP TOP 10 2021                              â”‚ â”‚
â”‚  â”‚                                                       â”‚ â”‚
â”‚  â”‚ 3. å®šç¾©è¼¸å‡ºæ ¼å¼                                       â”‚ â”‚
â”‚  â”‚    - JSON Schema                                     â”‚ â”‚
â”‚  â”‚    - åš´æ ¼çš„è¼¸å‡ºè¦å‰‡                                   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  èª¿ç”¨ AI æ¨¡å‹ (backend/index.js: 1560-1603)                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ é¸é … A: Gemini (Google AI)                           â”‚ â”‚
â”‚  â”‚ - genAI.getGenerativeModel({ model })                â”‚ â”‚
â”‚  â”‚ - generateContent(aiPrompt)                          â”‚ â”‚
â”‚  â”‚                                                       â”‚ â”‚
â”‚  â”‚ é¸é … B: Ollama (æœ¬åœ°éƒ¨ç½²)                            â”‚ â”‚
â”‚  â”‚ - POST http://localhost:11434/api/generate           â”‚ â”‚
â”‚  â”‚ - model: 'gemma3:4b'                                 â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è§£æ AI å›æ‡‰ (backend/index.js: 1605-1632)                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ 1. å˜—è©¦ç›´æ¥è§£æ JSON                                  â”‚ â”‚
â”‚  â”‚    JSON.parse(responseText)                          â”‚ â”‚
â”‚  â”‚                                                       â”‚ â”‚
â”‚  â”‚ 2. å¤±æ•—æ™‚å¾ markdown æå–                             â”‚ â”‚
â”‚  â”‚    responseText.match(/```json\s*([\s\S]*?)\s*```/)  â”‚ â”‚
â”‚  â”‚                                                       â”‚ â”‚
â”‚  â”‚ 3. å†å¤±æ•—æ™‚ä½¿ç”¨ Fallback                              â”‚ â”‚
â”‚  â”‚    wafService.generateFallbackRisks(analysisData)    â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è¿”å›çµæœçµ¦å‰ç«¯                                             â”‚
â”‚  {                                                          â”‚
â”‚    success: true,                                           â”‚
â”‚    risks: [...],                                            â”‚
â”‚    metadata: {                                              â”‚
â”‚      totalEvents: 1234,                                     â”‚
â”‚      timeRange: {...},                                      â”‚
â”‚      analysisTimestamp: '2025-11-12T12:00:00Z'             â”‚
â”‚    }                                                        â”‚
â”‚  }                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å‰ç«¯æ›´æ–°é¡¯ç¤º (page.tsx)                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ 1. æ›´æ–°åˆ†æè³‡è¨Šå€                                     â”‚ â”‚
â”‚  â”‚    - setAnalysisMetadata(data.metadata)              â”‚ â”‚
â”‚  â”‚                                                       â”‚ â”‚
â”‚  â”‚ 2. æ›´æ–°é¢¨éšªåˆ—è¡¨                                       â”‚ â”‚
â”‚  â”‚    - setWafRisks(data.risks)                         â”‚ â”‚
â”‚  â”‚                                                       â”‚ â”‚
â”‚  â”‚ 3. åˆ†é¡çµ±è¨ˆ                                           â”‚ â”‚
â”‚  â”‚    - risksByCategory (high/medium/low)               â”‚ â”‚
â”‚  â”‚                                                       â”‚ â”‚
â”‚  â”‚ 4. æ¸²æŸ“ UI                                            â”‚ â”‚
â”‚  â”‚    - é¢¨éšªè©•ä¼°å¡ç‰‡                                     â”‚ â”‚
â”‚  â”‚    - è¶¨å‹¢åˆ†æè©³æƒ…                                     â”‚ â”‚
â”‚  â”‚    - åŸ·è¡Œå»ºè­°                                         â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## â° æ™‚é–“ç¯„åœåŠŸèƒ½

### **æ™‚é–“ç¯„åœé¸é …**

| é¡¯ç¤ºåç¨± | API åƒæ•¸ | èªªæ˜ | æŸ¥è©¢ç¯„åœ |
|---------|---------|------|---------|
| 1å°æ™‚ | `1h` | éå» 1 å°æ™‚ | now-1h to now |
| 6å°æ™‚ | `6h` | éå» 6 å°æ™‚ | now-6h to now |
| 12å°æ™‚ | `12h` | éå» 12 å°æ™‚ | now-12h to now |
| 24å°æ™‚ | `24h` | éå» 24 å°æ™‚ï¼ˆé è¨­ï¼‰ | now-24h to now |
| 7å¤© | `7d` | éå» 7 å¤© | now-7d to now |
| 30å¤© | `30d` | éå» 30 å¤© | now-30d to now |

### **æ™‚é–“ç¯„åœè™•ç†æµç¨‹**

```typescript
// 1. å‰ç«¯é¸æ“‡æ™‚é–“ç¯„åœ
const handleTimeRangeChange = (timeRange: string) => {
  setSelectedTimeRange(timeRange)
  setWafRisks([])  // æ¸…ç©ºç¾æœ‰è³‡æ–™
  setHasAttemptedLoad(false)  // è§¸ç™¼é‡æ–°è¼‰å…¥
}

// 2. ç™¼é€åˆ°å¾Œç«¯
fetch('/api/analyze-waf-risks-cloudflare', {
  body: JSON.stringify({ timeRange: '24h' })
})

// 3. å¾Œç«¯è§£ææ™‚é–“ç¯„åœ
parseTimeRange(timeRange) {
  const unit = timeRange.slice(-1)  // 'h' or 'd'
  const value = parseInt(timeRange.slice(0, -1))
  
  if (unit === 'h') {
    return value * 60 * 60 * 1000  // å°æ™‚è½‰æ¯«ç§’
  } else if (unit === 'd') {
    return value * 24 * 60 * 60 * 1000  // å¤©è½‰æ¯«ç§’
  }
}

// 4. Elasticsearch æŸ¥è©¢
query: {
  range: {
    "@timestamp": {
      gte: `now-${timeRange}`,
      lte: "now"
    }
  }
}
```

---

## ğŸ“‹ API å¿«é€Ÿåƒè€ƒè¡¨

### **API ç«¯é»ç¸½è¦½**

| API åç¨± | Method | ç«¯é» | åŠŸèƒ½ |
|---------|--------|------|------|
| Cloudflare WAF åˆ†æ | POST | `/api/analyze-waf-risks-cloudflare` | ä¸»è¦ AI åˆ†æ API |

### **æœå‹™é¡ç¸½è¦½**

| æœå‹™åç¨± | æª”æ¡ˆä½ç½® | ä¸»è¦åŠŸèƒ½ |
|---------|---------|---------|
| ElkMCPClient | `backend/services/elkMCPClient.js` | ELK æŸ¥è©¢æœå‹™ |
| CloudflareWAFRiskService | `backend/services/cloudflareWAFRiskService.js` | WAF æ—¥èªŒåˆ†ææœå‹™ |
| CLOUDFLARE_FIELD_MAPPING | `cloudflare-field-mapping.js` | æ¬„ä½æ˜ å°„é…ç½® |
| cloudflareStandards | `backend/config/cloudflareStandards.js` | WAF åˆ†æ•¸æ¨™æº– |

### **æ ¸å¿ƒæ–¹æ³•ç¸½è¦½**

| æ–¹æ³•åç¨± | æ‰€å±¬æœå‹™ | åŠŸèƒ½ |
|---------|---------|------|
| `analyzeCloudflareWAF(timeRange)` | CloudflareWAFRiskService | ä¸»åˆ†ææ–¹æ³• |
| `generateAIPrompt(analysisData)` | CloudflareWAFRiskService | ç”Ÿæˆ AI Prompt |
| `analyzeSQLInjection(logEntries)` | CloudflareWAFRiskService | SQL æ³¨å…¥åˆ†æ |
| `analyzeXSSAttacks(logEntries)` | CloudflareWAFRiskService | XSS æ”»æ“Šåˆ†æ |
| `analyzeRCEAttacks(logEntries)` | CloudflareWAFRiskService | RCE æ”»æ“Šåˆ†æ |
| `analyzeBotTraffic(logEntries)` | CloudflareWAFRiskService | Bot æµé‡åˆ†æ |
| `queryElasticsearch(timeRange)` | ElkMCPClient | ELK æŸ¥è©¢ |
| `buildElasticsearchQuery(timeRange)` | ElkMCPClient | æ§‹å»ºæŸ¥è©¢ |

---

## ğŸ”§ ç’°å¢ƒé…ç½®èˆ‡è¨­å®š

### **1. ç’°å¢ƒè®Šæ•¸é…ç½®**

#### **å¾Œç«¯ç’°å¢ƒè®Šæ•¸** (`backend/env.example`)

```bash
# AI åˆ†æé…ç½®
GEMINI_API_KEY=your_gemini_api_key_here
GEMINI_MODEL=gemini-2.5-flash

# ELK MCP é€£æ¥é…ç½®
ELK_MCP_SERVER_URL=http://10.168.10.250:8080
ELK_MCP_PROTOCOL=proxy  # 'proxy' æˆ– 'stdio'

# Elasticsearch é…ç½®
ELK_HOST=https://10.168.10.250:9200
ELK_INDEX=adasone-cf-logpush-*
ELK_API_KEY=your_elasticsearch_api_key
ELK_MAX_RESULTS=10000

# æŸ¥è©¢é…ç½®
ELK_TIME_RANGE=1h
ELK_MAX_TIME_RANGE=24h
ELK_ATTACK_THRESHOLD=20
ELK_TIME_WINDOW=10

# æœå‹™é…ç½®
PORT=8080
NODE_ENV=development
```

**é‡è¦èªªæ˜**ï¼š
- Gemini API Key å¯ä»¥åœ¨å‰ç«¯ã€ŒAI æ¨¡å‹è¨­å®šã€é é¢è¼¸å…¥ï¼Œç„¡éœ€åœ¨å¾Œç«¯è¨­å®š
- ELK ç›¸é—œè¨­å®šå·²å¯«åœ¨ `backend/config/elkConfig.js` ä¸­
- `.env` æª”æ¡ˆä¸»è¦ç”¨æ–¼é–‹ç™¼æ¸¬è©¦è…³æœ¬ï¼Œæ­£å¸¸å•Ÿå‹•ä¸ä¸€å®šéœ€è¦

#### **å‰ç«¯é…ç½®** (localStorage)

å‰ç«¯ä½¿ç”¨ localStorage å„²å­˜ AI é…ç½®ï¼š

```javascript
// AI æä¾›è€…é¸æ“‡
localStorage.setItem('aiProvider', 'ollama')  // 'ollama' æˆ– 'gemini'

// Gemini API Key (é¸ç”¨)
localStorage.setItem('geminiApiKey', 'your-api-key')

// Ollama æ¨¡å‹
localStorage.setItem('ollamaModel', 'gemma3:4b')
```

---

### **2. AI æ¨¡å‹é…ç½®èˆ‡é¸æ“‡**

ç³»çµ±æ”¯æ´å…©ç¨® AI æ¨¡å‹ï¼š**Ollamaï¼ˆæœ¬åœ°ï¼‰** å’Œ **Geminiï¼ˆé›²ç«¯ï¼‰**

#### **Ollamaï¼ˆæ¨è–¦ç”¨æ–¼æœ¬åœ°éƒ¨ç½²ï¼‰**

**å„ªé»**ï¼š
- âœ… å®Œå…¨æœ¬åœ°é‹è¡Œï¼Œç„¡éœ€ API Key
- âœ… è³‡æ–™éš±ç§æ€§é«˜
- âœ… ç„¡ä½¿ç”¨é‡é™åˆ¶
- âœ… å›æ‡‰é€Ÿåº¦å¿«ï¼ˆå–æ±ºæ–¼ç¡¬é«”ï¼‰

**è¨­å®šæ–¹å¼**ï¼š

```bash
# 1. å®‰è£ Ollama
curl -fsSL https://ollama.com/install.sh | sh

# 2. ä¸‹è¼‰æ¨¡å‹
ollama pull gemma3:4b

# 3. å•Ÿå‹• Ollama æœå‹™ï¼ˆé è¨­ç«¯å£ 11434ï¼‰
ollama serve
```

**å‰ç«¯é…ç½®**ï¼š
```javascript
aiProvider: 'ollama'
model: 'gemma3:4b'
apiKey: ''  // ä¸éœ€è¦
```

**å¾Œç«¯ç’°å¢ƒè®Šæ•¸**ï¼š
```bash
OLLAMA_URL=http://localhost:11434  # å¯é¸ï¼Œé è¨­å€¼
```

#### **Geminiï¼ˆGoogle Cloud AIï¼‰**

**å„ªé»**ï¼š
- âœ… é›²ç«¯é‹ç®—ï¼Œç„¡éœ€æœ¬åœ° GPU
- âœ… æ¨¡å‹æ›´æ–°å¿«é€Ÿ
- âœ… æ”¯æ´æœ€æ–° Gemini 2.0 Flash

**é™åˆ¶**ï¼š
- âš ï¸ éœ€è¦ API Key
- âš ï¸ æœ‰ä½¿ç”¨é‡é™åˆ¶
- âš ï¸ è³‡æ–™æœƒå‚³é€åˆ° Google ä¼ºæœå™¨

**è¨­å®šæ–¹å¼**ï¼š

1. å–å¾— API Keyï¼šhttps://makersuite.google.com/app/apikey
2. åœ¨å‰ç«¯ã€ŒAI æ¨¡å‹è¨­å®šã€é é¢è¼¸å…¥

**å‰ç«¯é…ç½®**ï¼š
```javascript
aiProvider: 'gemini'
model: 'gemini-2.0-flash-exp'
apiKey: 'your-api-key'
```

#### **API å¯¦ç¾ï¼šè‡ªå‹•åˆ‡æ›é‚è¼¯**

å¾Œç«¯ API (`backend/index.js: 1530-1650`) æ”¯æ´è‡ªå‹•åˆ‡æ›ï¼š

```javascript
if (aiProvider === 'ollama') {
  // Ollama è«‹æ±‚
  const response = await fetch(`${ollamaUrl}/api/generate`, {
    method: 'POST',
    body: JSON.stringify({
      model: 'gemma3:4b',
      prompt: aiPrompt,
      stream: false
    })
  });
} else {
  // Gemini è«‹æ±‚
  const genAI = new GoogleGenerativeAI(apiKey);
  const model = genAI.getGenerativeModel({ model: 'gemini-2.0-flash-exp' });
  const result = await model.generateContent(aiPrompt);
}
```

---

## ğŸ›¡ï¸ éŒ¯èª¤è™•ç†èˆ‡ Fallback æ©Ÿåˆ¶

### **1. AI å›æ‡‰è§£æå¤±æ•—è™•ç†**

ç³»çµ±å…·å‚™ä¸‰å±¤ JSON è§£ææ©Ÿåˆ¶ï¼š

```javascript
// å±¤ç´š 1: ç›´æ¥è§£æ JSON
try {
  aiAnalysis = JSON.parse(responseText);
} catch (parseError) {
  
  // å±¤ç´š 2: å¾ markdown code block æå–
  const jsonMatch = responseText.match(/```json\s*([\s\S]*?)\s*```/);
  if (jsonMatch) {
    aiAnalysis = JSON.parse(jsonMatch[1]);
  } else {
    
    // å±¤ç´š 3: ä½¿ç”¨ Fallback è³‡æ–™
    aiAnalysis = wafService.generateFallbackRisks(analysisData);
  }
}
```

### **2. Fallback é¢¨éšªæ•¸æ“šç”Ÿæˆ**

ç•¶ AI è§£æå¤±æ•—æ™‚ï¼Œç³»çµ±æœƒåŸºæ–¼çœŸå¯¦çµ±è¨ˆæ•¸æ“šç”Ÿæˆå‚™ç”¨é¢¨éšªå ±å‘Šï¼š

**ç”Ÿæˆè¦å‰‡**ï¼š
- åªç”Ÿæˆæª¢æ¸¬æ¬¡æ•¸ > 0 çš„æ”»æ“Šé¡å‹
- ä½¿ç”¨çœŸå¯¦çš„çµ±è¨ˆæ•¸æ“šï¼ˆTop IPã€Top URLã€WAF åˆ†æ•¸ï¼‰
- severity æ ¹æ“š WAF åˆ†æ•¸è‡ªå‹•åˆ¤å®š
- åŒ…å«åŸºæœ¬çš„å»ºè­°æªæ–½

**æ–¹æ³•ä½ç½®**ï¼š`backend/services/cloudflareWAFRiskService.js: generateFallbackRisks()`

### **3. ELK é€£æ¥å¤±æ•—è™•ç†**

```javascript
try {
  const elkData = await elkClient.queryElasticsearch(timeRange);
  
  if (!elkData.hits || elkData.hits.length === 0) {
    // è¿”å›ç©ºçµæœ
    return {
      success: true,
      risks: [],
      metadata: {
        totalEvents: 0,
        timeRange: { start: '', end: '' },
        analysisTimestamp: new Date().toISOString()
      }
    };
  }
} catch (error) {
  console.error('ELK æŸ¥è©¢å¤±æ•—:', error);
  throw new Error('ELK é€£æ¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥é…ç½®');
}
```

**å‰ç«¯é¡¯ç¤º**ï¼š
- é¡¯ç¤ºã€ŒELK ä¸­æ²’æœ‰è¶³å¤ çš„æ—¥èªŒæ•¸æ“šã€æç¤º
- æä¾›é‡æ–°è¼‰å…¥æŒ‰éˆ•
- é¡¯ç¤ºé€£æ¥ç‹€æ…‹ï¼ˆå·²é€£æ¥/ç„¡æ•¸æ“šï¼‰

---

## ğŸ—‚ï¸ ç‹€æ…‹ç®¡ç† (WAFDataContext)

### **Context Provider æ¶æ§‹**

ç³»çµ±ä½¿ç”¨ React Context API ç®¡ç†å…¨åŸŸ WAF é¢¨éšªæ•¸æ“šã€‚

#### **å®šç¾©ä½ç½®**ï¼š`frontend/app/dashboard/waf-data-context.tsx`

```typescript
interface WAFRiskData {
  id: string
  title: string
  severity: "critical" | "high" | "medium" | "low"
  openIssues: number
  resolvedIssues: number
  affectedAssets: number
  tags: string[]
  description: string
  aiInsight?: string
  createdDate: string
  updatedDate: string
  exploitInWild: boolean
  internetExposed: boolean
  confirmedExploitable: boolean
  cveId?: string
  recommendations: {
    title: string
    description: string
    priority: "high" | "medium" | "low"
  }[]
}

export function useWAFData() {
  const { wafRisks, setWafRisks } = useContext(WAFDataContext)
  return { wafRisks, setWafRisks }
}
```

#### **ä½¿ç”¨æ–¹å¼**

åœ¨ Cloudflare AI Analysis é é¢ä¸­ï¼š

```typescript
// 1. å°å…¥ Hook
import { useWAFData } from "@/app/dashboard/waf-data-context"

// 2. ä½¿ç”¨ç‹€æ…‹
const { wafRisks, setWafRisks } = useWAFData()

// 3. æ›´æ–°æ•¸æ“š
useEffect(() => {
  const loadData = async () => {
    const response = await fetch('/api/analyze-waf-risks-cloudflare', {
      method: 'POST',
      body: JSON.stringify({ timeRange: '24h' })
    })
    const data = await response.json()
    setWafRisks(data.risks)  // æ›´æ–°å…¨åŸŸç‹€æ…‹
  }
  loadData()
}, [])
```

**å„ªé»**ï¼š
- âœ… è·¨é é¢å…±äº«æ•¸æ“š
- âœ… é¿å…é‡è¤‡ API è«‹æ±‚
- âœ… é›†ä¸­å¼ç‹€æ…‹ç®¡ç†

---

## ğŸ“ åƒè€ƒè³‡æº

### **æ ¸å¿ƒæª”æ¡ˆæ¸…å–®**

#### **å‰ç«¯**
- ğŸ“„ ä¸»é é¢ï¼š`frontend/app/ai-analysis/cloudflare/page.tsx`
- ğŸ“„ ç‹€æ…‹ç®¡ç†ï¼š`frontend/app/dashboard/waf-data-context.tsx`

#### **å¾Œç«¯ API**
- ğŸ“„ ä¸»è¦ APIï¼š`backend/index.js` (è¡Œ 1530-1650) - `/api/analyze-waf-risks-cloudflare`

#### **å¾Œç«¯æœå‹™**
- ğŸ“„ WAF åˆ†ææœå‹™ï¼š`backend/services/cloudflareWAFRiskService.js`
- ğŸ“„ ELK MCP å®¢æˆ¶ç«¯ï¼š`backend/services/elkMCPClient.js`

#### **é…ç½®æ–‡ä»¶**
- âš™ï¸ ELK é…ç½®ï¼š`backend/config/elkConfig.js`
- âš™ï¸ Cloudflare æ¨™æº–ï¼š`backend/config/cloudflareStandards.js`
- âš™ï¸ æ™‚é–“ç¯„åœé…ç½®ï¼š`backend/config/timeRangeConfig.js`
- âš™ï¸ æ¬„ä½æ˜ å°„ï¼š`cloudflare-field-mapping.js`

#### **AI Prompt æ–‡æª”**
- ğŸ“– å®Œæ•´ Prompt è¨­è¨ˆï¼š`backend/prompts/cloudflare-waf-analysis-prompt.md`
- ğŸ“– Prompt æ•´åˆç¯„ä¾‹ï¼š`backend/prompts/prompt-integration-example.js`
- ğŸ“– å¯¦æ–½èªªæ˜ï¼š`backend/prompts/README.md`

#### **éƒ¨ç½²èˆ‡æ¸¬è©¦**
- ğŸ“– å•Ÿå‹•æŒ‡å—ï¼š`STARTUP_GUIDE.md`
- ğŸ”§ æ¸¬è©¦è…³æœ¬ï¼š`backend/_dev/` ç›®éŒ„ä¸‹çš„æ¸¬è©¦æª”æ¡ˆ

#### **åƒè€ƒæ¨™æº–**
- ğŸ“š Cloudflare å®˜æ–¹æ–‡æª”ï¼š`cloudflare-docs/stages/stage-4-security-products/`
- ğŸ“š OWASP TOP 10 2021ï¼šhttps://owasp.org/Top10/

---

**æ–‡ä»¶ç‰ˆæœ¬**: 2.0ï¼ˆç²¾ç°¡ç‰ˆï¼‰  
**æ›´æ–°æ—¥æœŸ**: 2025-11-13  
**æ–‡ä»¶çµæŸ**


